<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#121211">
  <title>Bloques de Oro - El Dorado</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Archivo+Narrow:wght@400;700&family=Geist:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; }

    :root {
      --bg: #121211;
      --surface: #1a1a19;
      --surface-secondary: #2a2a28;
      --text-primary: #fcfcfc;
      --text-secondary: #b9b9b3;
      --brand: #e5e517;
      --brand-light: #eaea43;
      --brand-glow: rgba(229, 229, 23, 0.15);
      --brand-glow-strong: rgba(229, 229, 23, 0.3);
      --stroke-secondary: #2a2a28;
      --stroke-brand: #e5e517;
      --danger: #e54017;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    html, body {
      background: var(--bg);
      color: var(--text-primary);
      font-family: 'Geist', -apple-system, sans-serif;
      height: 100%;
      overflow: hidden;
      touch-action: none;
      position: fixed;
      width: 100%;
    }

    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: var(--safe-top);
      padding-bottom: var(--safe-bottom);
    }

    .app {
      width: 100%;
      max-width: 430px;
      height: 100%;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }

    /* ========== TOP BAR ========== */
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      border-bottom: 1px solid var(--stroke-secondary);
      flex-shrink: 0;
    }

    .top-bar-logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      background: var(--brand);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo-icon svg { width: 20px; height: 20px; }

    .top-bar-title {
      font-family: 'Archivo Narrow', sans-serif;
      font-weight: 700;
      font-size: 18px;
      letter-spacing: 1.5px;
    }

    .ranking-btn {
      font-family: 'Archivo Narrow', sans-serif;
      font-weight: 700;
      font-size: 12px;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      background: var(--surface-secondary);
      color: var(--text-primary);
      border: 1px solid var(--stroke-secondary);
      border-radius: 8px;
      padding: 8px 14px;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    /* ========== SCORE AREA ========== */
    .score-area {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      flex-shrink: 0;
    }

    .score-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }

    .score-label {
      font-size: 10px;
      font-weight: 700;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 2px;
      font-family: 'Archivo Narrow', sans-serif;
    }

    .score-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--brand);
      font-family: 'Geist', sans-serif;
      line-height: 1;
    }

    .score-value.best {
      color: var(--text-primary);
      font-size: 22px;
    }

    .combo-indicator {
      background: var(--brand-glow);
      border: 1px solid var(--brand);
      border-radius: 20px;
      padding: 6px 16px;
      font-size: 13px;
      font-weight: 700;
      color: var(--brand);
      font-family: 'Archivo Narrow', sans-serif;
      letter-spacing: 1.5px;
      opacity: 0;
      transition: opacity 0.3s, transform 0.3s;
      transform: scale(0.8);
    }

    .combo-indicator.visible {
      opacity: 1;
      transform: scale(1);
    }

    /* ========== REWARD BANNER ========== */
    .reward-banner {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 0 16px 8px;
      padding: 8px 12px;
      background: var(--brand-glow);
      border: 1px solid rgba(229, 229, 23, 0.25);
      border-radius: 10px;
      flex-shrink: 0;
    }

    .reward-banner .coin {
      font-size: 20px;
      flex-shrink: 0;
    }

    .reward-banner .reward-text {
      font-size: 12px;
      color: var(--text-secondary);
      line-height: 1.3;
    }

    .reward-banner .reward-text strong {
      color: var(--brand);
    }

    /* ========== GRID ========== */
    .grid-wrapper {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 12px;
      min-height: 0;
    }

    .grid-container {
      position: relative;
      width: 100%;
      max-width: 360px;
      aspect-ratio: 1;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      grid-template-rows: repeat(8, 1fr);
      gap: 3px;
      width: 100%;
      height: 100%;
      background: var(--surface);
      border-radius: 10px;
      padding: 6px;
      border: 1px solid var(--stroke-secondary);
    }

    .cell {
      background: var(--surface-secondary);
      border-radius: 3px;
      transition: background 0.12s, transform 0.12s, box-shadow 0.12s;
    }

    .cell.filled {
      background: var(--brand);
      box-shadow: inset 0 -2px 0 rgba(0,0,0,0.25), 0 0 8px var(--brand-glow);
    }

    .cell.preview {
      background: rgba(229, 229, 23, 0.3);
      box-shadow: inset 0 0 0 1.5px rgba(229, 229, 23, 0.5);
    }

    .cell.invalid-preview {
      background: rgba(229, 64, 23, 0.2);
      box-shadow: inset 0 0 0 1.5px rgba(229, 64, 23, 0.4);
    }

    .cell.special {
      background: var(--brand);
      border: 1.5px solid #ffd700;
      box-shadow: inset 0 -2px 0 rgba(0,0,0,0.25), 0 0 8px var(--brand-glow), 0 0 12px rgba(255,215,0,0.3);
      animation: specialGlow 2s ease-in-out infinite;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .cell.special img {
      width: 80%;
      height: 80%;
      object-fit: contain;
      filter: drop-shadow(0 0 2px rgba(0,0,0,0.5));
    }

    @keyframes specialGlow {
      0%, 100% { box-shadow: inset 0 -2px 0 rgba(0,0,0,0.25), 0 0 8px var(--brand-glow), 0 0 12px rgba(255,215,0,0.3); }
      50% { box-shadow: inset 0 -2px 0 rgba(0,0,0,0.25), 0 0 14px var(--brand-glow-strong), 0 0 20px rgba(255,215,0,0.5); }
    }

    .cell.special.clearing {
      animation: specialClearExplode 0.7s ease-out forwards;
      z-index: 10;
    }

    @keyframes specialClearExplode {
      0% { background: #ffd700; transform: scale(1); opacity: 1; box-shadow: 0 0 12px #ffd700; }
      15% { background: #fff; transform: scale(1.8); opacity: 1; box-shadow: 0 0 30px #fff, 0 0 50px #ffd700; }
      40% { background: #ffd700; transform: scale(0.5); opacity: 0.9; box-shadow: 0 0 10px #ffd700; }
      100% { background: var(--surface-secondary); transform: scale(1); opacity: 1; box-shadow: none; }
    }

    .cell.clearing {
      animation: clearExplode 0.6s ease-out forwards;
      z-index: 10;
    }

    @keyframes clearExplode {
      0% { background: var(--brand); transform: scale(1); opacity: 1; box-shadow: 0 0 8px var(--brand); }
      20% { background: #fff; transform: scale(1.5); opacity: 1; box-shadow: 0 0 20px #fff, 0 0 40px var(--brand); }
      50% { background: var(--brand); transform: scale(0.4); opacity: 0.8; box-shadow: 0 0 4px var(--brand); }
      100% { background: var(--surface-secondary); transform: scale(1); opacity: 1; box-shadow: none; }
    }

    .grid.shake {
      animation: gridShake 0.4s ease-out;
    }

    @keyframes gridShake {
      0%, 100% { transform: translateX(0); }
      15% { transform: translateX(-3px); }
      30% { transform: translateX(3px); }
      45% { transform: translateX(-2px); }
      60% { transform: translateX(2px); }
      75% { transform: translateX(-1px); }
    }

    .line-flash {
      position: absolute;
      pointer-events: none;
      z-index: 50;
      background: linear-gradient(90deg, transparent, rgba(229,229,23,0.6), rgba(255,255,255,0.8), rgba(229,229,23,0.6), transparent);
      animation: flashSweep 0.5s ease-out forwards;
    }

    @keyframes flashSweep {
      0% { opacity: 1; transform: scaleX(0.3); }
      40% { opacity: 1; transform: scaleX(1.1); }
      100% { opacity: 0; transform: scaleX(1.2); }
    }

    .explosion-particle {
      position: absolute;
      border-radius: 50%;
      pointer-events: none;
      z-index: 100;
      animation: particleFly var(--dur, 0.7s) ease-out forwards;
    }

    @keyframes particleFly {
      0% { transform: translate(0, 0) scale(1); opacity: 1; }
      60% { opacity: 0.8; }
      100% { transform: translate(var(--tx, 20px), var(--ty, -20px)) scale(0); opacity: 0; }
    }

    /* ========== PIECES ========== */
    .pieces-area {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      padding: 12px;
      flex-shrink: 0;
    }

    .piece-slot {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100px;
      height: 100px;
      background: var(--surface);
      border-radius: 10px;
      border: 1px solid var(--stroke-secondary);
      cursor: grab;
      transition: transform 0.2s, opacity 0.3s;
    }

    .piece-slot:active { cursor: grabbing; }
    .piece-slot.dragging { opacity: 0.3; transform: scale(0.85); }
    .piece-slot.used { opacity: 0.1; pointer-events: none; }

    .piece-grid { display: grid; gap: 2px; }

    .piece-cell {
      width: 16px;
      height: 16px;
      border-radius: 2px;
    }

    .piece-cell.active {
      background: var(--brand);
      box-shadow: inset 0 -1px 0 rgba(0,0,0,0.2);
    }

    .piece-cell.special {
      background: var(--brand);
      box-shadow: inset 0 -1px 0 rgba(0,0,0,0.2), 0 0 6px rgba(255,215,0,0.4);
      border: 1px solid #ffd700;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .piece-cell.special img {
      width: 12px;
      height: 12px;
      object-fit: contain;
    }

    .piece-cell.empty { background: transparent; }

    /* ========== FLOATING PIECE ========== */
    .floating-piece {
      position: fixed;
      pointer-events: none;
      z-index: 100;
      display: grid;
      gap: 3px;
      opacity: 0.85;
      filter: drop-shadow(0 4px 12px rgba(229, 229, 23, 0.3));
    }

    .floating-cell {
      border-radius: 3px;
      background: var(--brand);
      box-shadow: inset 0 -2px 0 rgba(0,0,0,0.25);
    }

    .floating-cell.empty { background: transparent; box-shadow: none; }

    .floating-cell.special {
      background: var(--brand);
      border: 1.5px solid #ffd700;
      box-shadow: inset 0 -2px 0 rgba(0,0,0,0.25), 0 0 8px rgba(255,215,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .floating-cell.special img {
      width: 80%;
      height: 80%;
      object-fit: contain;
      filter: drop-shadow(0 0 2px rgba(0,0,0,0.5));
    }

    /* ========== BOTTOM BAR ========== */
    .bottom-bar {
      display: flex;
      justify-content: center;
      padding: 8px 16px 12px;
      flex-shrink: 0;
    }

    .btn {
      font-family: 'Archivo Narrow', sans-serif;
      font-weight: 700;
      font-size: 14px;
      letter-spacing: 2px;
      text-transform: uppercase;
      border: none;
      border-radius: 8px;
      padding: 12px 28px;
      cursor: pointer;
      transition: transform 0.1s;
    }

    .btn:active { transform: scale(0.96); }
    .btn-primary { background: var(--brand); color: var(--bg); }
    .btn-secondary { background: var(--surface-secondary); color: var(--text-primary); border: 1px solid var(--stroke-secondary); }

    /* ========== OVERLAYS ========== */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(18, 18, 17, 0.94);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 200;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s;
    }

    .overlay.visible { opacity: 1; pointer-events: all; }

    .overlay-card {
      background: var(--surface);
      border: 1px solid var(--stroke-secondary);
      border-radius: 20px;
      padding: 32px 28px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      width: 320px;
      max-width: 90vw;
    }

    .overlay-emoji { font-size: 48px; line-height: 1; }

    .overlay-title {
      font-family: 'Archivo Narrow', sans-serif;
      font-size: 26px;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      text-align: center;
    }

    .overlay-score {
      font-size: 64px;
      font-weight: 700;
      color: var(--brand);
      line-height: 1;
    }

    .overlay-reward {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--brand-glow);
      border: 1px solid rgba(229, 229, 23, 0.3);
      border-radius: 12px;
      padding: 10px 16px;
      width: 100%;
      justify-content: center;
    }

    .overlay-reward-text {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .overlay-reward-text strong {
      color: var(--brand);
      font-weight: 700;
    }

    .go-top3 { width: 100%; }
    .go-top3-label { font-size: 10px; color: var(--text-secondary); font-family: 'Archivo Narrow', sans-serif; text-transform: uppercase; letter-spacing: 1.5px; text-align: center; margin-bottom: 8px; }
    .go-top3-list { display: flex; flex-direction: column; gap: 4px; }
    .go-top3-row { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: rgba(255,255,255,0.04); border-radius: 8px; border: 1px solid transparent; }
    .go-top3-row.me { background: rgba(229,229,23,0.1); border-color: rgba(229,229,23,0.25); }
    .go-top3-rank { font-size: 16px; width: 24px; text-align: center; flex-shrink: 0; }
    .go-top3-name { flex: 1; font-size: 13px; font-weight: 600; color: var(--text-primary); font-family: 'Geist', sans-serif; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .go-top3-pts { font-size: 13px; font-weight: 700; color: var(--text-secondary); font-family: 'Archivo Narrow', sans-serif; flex-shrink: 0; }
    .go-top3-row.me .go-top3-name, .go-top3-row.me .go-top3-pts { color: var(--brand); }

    .overlay-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 100%;
    }

    .overlay-buttons .btn {
      width: 100%;
      padding: 14px;
      font-size: 15px;
    }

    /* ========== WELCOME SCREEN ========== */
    .welcome-screen {
      position: fixed;
      inset: 0;
      background: var(--bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 300;
      transition: opacity 0.5s;
      gap: 16px;
      padding: 24px;
      overflow-y: auto;
    }

    .welcome-screen.hidden { opacity: 0; pointer-events: none; }

    .welcome-logo {
      width: 72px;
      height: 72px;
      background: var(--brand);
      border-radius: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 40px var(--brand-glow-strong);
    }

    .welcome-logo svg { width: 44px; height: 44px; }

    .welcome-title {
      font-family: 'Archivo Narrow', sans-serif;
      font-size: 36px;
      font-weight: 700;
      letter-spacing: 3px;
      text-transform: uppercase;
      text-align: center;
    }

    .welcome-subtitle {
      font-size: 15px;
      color: var(--text-secondary);
      text-align: center;
      line-height: 1.5;
      max-width: 280px;
    }

    .welcome-subtitle strong { color: var(--brand); }

    .welcome-crypto-icons {
      display: flex;
      gap: 16px;
      margin: 8px 0;
    }

    .crypto-chip {
      background: var(--surface-secondary);
      border: 1px solid var(--stroke-secondary);
      border-radius: 20px;
      padding: 6px 14px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .crypto-chip .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .dot-usdt { background: #26a17b; }
    .dot-btc { background: #f7931a; }
    .dot-eth { background: #627eea; }

    .welcome-btn {
      width: 100%;
      max-width: 300px;
      padding: 16px;
      font-size: 16px;
      margin-top: 8px;
    }

    .welcome-leaderboard {
      width: 100%;
      max-width: 320px;
      background: var(--surface);
      border: 1px solid var(--stroke-secondary);
      border-radius: 14px;
      padding: 14px;
    }

    .welcome-lb-title {
      font-family: 'Archivo Narrow', sans-serif;
      font-weight: 700;
      font-size: 11px;
      letter-spacing: 2px;
      color: var(--text-secondary);
      text-align: center;
      margin-bottom: 10px;
    }

    .welcome-lb-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .welcome-lb-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
      border: 1px solid transparent;
    }

    .welcome-lb-row.gold { background: rgba(229,229,23,0.08); border-color: rgba(229,229,23,0.2); }

    .welcome-lb-rank {
      font-size: 16px;
      width: 24px;
      text-align: center;
      flex-shrink: 0;
    }

    .welcome-lb-name {
      flex: 1;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .welcome-lb-score {
      font-size: 11px;
      color: var(--text-secondary);
      font-family: 'Archivo Narrow', sans-serif;
      flex-shrink: 0;
      margin-right: 4px;
    }

    .welcome-lb-prize {
      font-size: 12px;
      font-weight: 700;
      color: #26a17b;
      font-family: 'Archivo Narrow', sans-serif;
      flex-shrink: 0;
      letter-spacing: 0.5px;
    }

    .welcome-lb-row.skeleton {
      opacity: 0.3;
      height: 38px;
    }

    .welcome-lb-empty {
      text-align: center;
      font-size: 12px;
      color: var(--text-secondary);
      padding: 12px 0;
      opacity: 0.6;
    }

    .welcome-powered {
      font-size: 11px;
      color: var(--text-secondary);
      opacity: 0.5;
      letter-spacing: 1px;
      font-family: 'Archivo Narrow', sans-serif;
    }

    /* ========== SCORE POPUP ========== */
    .score-popup {
      position: fixed;
      pointer-events: none;
      z-index: 150;
      font-family: 'Archivo Narrow', sans-serif;
      font-weight: 700;
      font-size: 28px;
      color: var(--brand);
      text-shadow: 0 0 12px var(--brand-glow-strong);
      animation: scoreFloat 0.8s ease-out forwards;
    }

    @keyframes scoreFloat {
      0% { opacity: 1; transform: translateY(0) scale(1); }
      100% { opacity: 0; transform: translateY(-70px) scale(1.4); }
    }

    .bonus-popup {
      position: fixed;
      pointer-events: none;
      z-index: 155;
      display: flex;
      align-items: center;
      gap: 4px;
      font-family: 'Archivo Narrow', sans-serif;
      font-weight: 700;
      font-size: 24px;
      color: #ffd700;
      text-shadow: 0 0 12px rgba(255,215,0,0.6), 0 1px 3px rgba(0,0,0,0.5);
      animation: bonusFloat 1.1s ease-out forwards;
    }

    .bonus-popup img {
      width: 24px;
      height: 24px;
      object-fit: contain;
      filter: drop-shadow(0 0 4px rgba(255,215,0,0.5));
    }

    @keyframes bonusFloat {
      0% { opacity: 1; transform: translateY(0) scale(0.5); }
      15% { opacity: 1; transform: translateY(-10px) scale(1.3); }
      30% { opacity: 1; transform: translateY(-20px) scale(1.1); }
      100% { opacity: 0; transform: translateY(-90px) scale(1.4); }
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes boosterSlam {
      0% { opacity: 0; transform: translateY(-20px) scale(0.5); }
      50% { opacity: 1; transform: translateY(4px) scale(1.1); }
      70% { transform: translateY(-2px) scale(0.95); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }

    @keyframes scoreGlow {
      0% { text-shadow: 0 0 30px rgba(31,204,75,0.5); }
      50% { text-shadow: 0 0 60px rgba(31,204,75,0.8), 0 0 100px rgba(31,204,75,0.3); }
      100% { text-shadow: 0 0 30px rgba(31,204,75,0.5); }
    }

    @keyframes scorePulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.08); }
    }

    .multiplied-score-counting {
      animation: scoreGlow 0.6s ease-in-out infinite, scorePulse 0.3s ease-in-out infinite;
    }

    .multiplied-score-done {
      animation: scoreGlow 2s ease-in-out infinite;
    }

    .booster-reason-card {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 16px;
      background: rgba(229,229,23,0.08);
      border: 1.5px solid rgba(229,229,23,0.3);
      border-radius: 10px;
      animation: boosterSlam 0.5s cubic-bezier(0.34,1.56,0.64,1) forwards;
    }

    .booster-reason-card .booster-icon { font-size: 18px; }
    .booster-reason-card .booster-text { font-family: 'Geist',sans-serif; font-size: 13px; font-weight: 600; color: var(--brand); }
    .booster-reason-card .booster-mult { font-family: 'Archivo Narrow',sans-serif; font-weight: 700; font-size: 16px; color: #1fcc4b; text-shadow: 0 0 8px rgba(31,204,75,0.4); }

    /* ========== ANIMATIONS ========== */
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .home-indicator {
      width: 134px;
      height: 5px;
      background: var(--text-primary);
      border-radius: 3px;
      opacity: 0.15;
      margin-bottom: 4px;
      flex-shrink: 0;
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Top Bar -->
    <div class="top-bar">
      <div class="top-bar-logo">
        <div class="logo-icon">
          <svg viewBox="0 0 24 24" fill="none">
            <rect x="3" y="3" width="18" height="18" rx="3" fill="#121211"/>
            <text x="12" y="17" text-anchor="middle" font-family="Archivo Narrow" font-weight="700" font-size="15" fill="#e5e517">ED</text>
          </svg>
        </div>
        <span class="top-bar-title">BLOQUES DE ORO</span>
      </div>
      <button class="ranking-btn" id="leaderboardBtn">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 20V10M18 20V4M6 20v-4"/></svg>
        RANKING
      </button>
    </div>

    <!-- Score Area -->
    <div class="score-area">
      <div class="score-box">
        <span class="score-label">Puntos</span>
        <span class="score-value" id="score">0</span>
      </div>
      <div class="combo-indicator" id="combo">COMBO x2</div>
      <div class="score-box">
        <span class="score-label">Mejor</span>
        <span class="score-value best" id="bestScore">0</span>
      </div>
    </div>

    <!-- Reward Banner -->
    <div class="reward-banner" id="rewardBanner">
      <span class="coin">&#128161;</span>
      <span class="reward-text" id="rewardText">Activa los boosters en la pantalla principal para <strong>puntuar mas!</strong></span>
    </div>

    <!-- Grid -->
    <div class="grid-wrapper">
      <div class="grid-container">
        <div class="grid" id="grid"></div>
      </div>
    </div>

    <!-- Pieces -->
    <div class="pieces-area" id="piecesArea"></div>

    <!-- Bottom -->
    <div class="bottom-bar">
      <button class="btn btn-secondary" id="newGameBtn">NUEVO JUEGO</button>
    </div>

    <div class="home-indicator"></div>
  </div>

  <!-- Ranking Popup -->
  <div class="overlay" id="rankingOverlay">
    <div class="overlay-card" style="max-height:80vh;overflow-y:auto;">
      <div style="display:flex;align-items:center;justify-content:space-between;width:100%;">
        <div class="overlay-title" style="font-size:20px;">RANKING DEL D&Iacute;A</div>
        <button id="closeRankingBtn" style="background:var(--surface-secondary);border:1px solid var(--stroke-secondary);border-radius:8px;width:32px;height:32px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text-primary);font-size:18px;">&times;</button>
      </div>
      <div id="rankingPopupList" style="width:100%;display:flex;flex-direction:column;gap:4px;"></div>
    </div>
  </div>

  <!-- Welcome Screen -->
  <div class="welcome-screen" id="welcomeScreen">
    <div class="welcome-logo">
      <svg viewBox="0 0 24 24" fill="none">
        <text x="12" y="18" text-anchor="middle" font-family="Archivo Narrow" font-weight="700" font-size="16" fill="#121211">ED</text>
      </svg>
    </div>
    <div class="welcome-title">Bloques de Oro</div>
    <div class="welcome-subtitle">
      Juega, completa los boosters diarios y gana <strong>recompensas en USDT!</strong> Top 5 usuarios reciben premios diarios.
    </div>
    <div class="welcome-leaderboard" id="welcomeLeaderboard">
      <div class="welcome-lb-title">RANKING DEL DÍA</div>
      <div class="welcome-lb-list" id="welcomeLbList">
        <div class="welcome-lb-row skeleton"><span class="welcome-lb-rank">&nbsp;</span><span class="welcome-lb-name">&nbsp;</span><span class="welcome-lb-prize">&nbsp;</span></div>
      </div>
    </div>
    <button class="btn btn-primary welcome-btn" id="startBtn">JUGAR AHORA</button>
    <div class="welcome-powered">POWERED BY EL DORADO</div>
  </div>

  <!-- Game Over -->
  <div class="overlay" id="gameOverOverlay">
    <div class="overlay-card">
      <div class="overlay-emoji">&#x1F3C6;</div>
      <div class="overlay-title">Juego Terminado</div>
      <div class="overlay-score" id="finalScore">0</div>
      <div id="multiplierAnimation" style="display:none;text-align:center;margin:16px 0;">
        <div id="boosterReasons" style="display:flex;flex-direction:column;gap:8px;margin-bottom:14px;"></div>
        <div style="font-family:'Archivo Narrow',sans-serif;font-size:11px;letter-spacing:2px;color:var(--text-secondary);margin-bottom:4px;" id="multiplierLabel"></div>
        <div id="multipliedScore" style="font-family:'Archivo Narrow',sans-serif;font-weight:700;font-size:64px;color:#1fcc4b;text-shadow:0 0 30px rgba(31,204,75,0.5);transition:transform 0.15s,text-shadow 0.15s;"></div>
      </div>
      <div class="go-top3" id="goTop3">
        <div class="go-top3-label">RANKING DEL D&Iacute;A</div>
        <div class="go-top3-list" id="goTop3List"></div>
      </div>
      <div class="overlay-buttons">
        <button class="btn btn-primary" id="playAgainBtn">JUGAR DE NUEVO</button>
        <button class="btn btn-secondary" id="shareBtn">COMPARTE TU PUNTAJE CON AMIGOS</button>
      </div>
    </div>
  </div>

  <script src="/js/supabase-utils.js"></script>
  <script>
    // ========== AUTH CHECK ==========
    if (!SupabaseUtils.getCurrentUsername()) {
      window.location.href = '/username.html';
    }
    const _username = SupabaseUtils.getCurrentUsername();

    // ========== SEEDED PRNG (Mulberry32) ==========
    function mulberry32(seed) {
      return function() {
        seed |= 0; seed = seed + 0x6D2B79F5 | 0;
        var t = Math.imul(seed ^ seed >>> 15, 1 | seed);
        t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
      };
    }

    function makeSeed(gameNumber) {
      const d = new Date();
      const dateSeed = d.getFullYear() * 10000 + (d.getMonth() + 1) * 100 + d.getDate();
      return dateSeed * 1000 + gameNumber;
    }

    let rng = null; // seeded random function, set on init

    // ========== SPECIAL BLOCK ICONS (inline SVG data URIs) ==========
    const SPECIAL_ICONS = {
      // P2P - two arrows exchanging
      2: "data:image/svg+xml," + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><rect width="32" height="32" rx="6" fill="#121211"/><path d="M8 12h12l-3-3" stroke="#e5e517" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/><path d="M24 20H12l3 3" stroke="#e5e517" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>'),
      // Cuenta USA - bank/building
      3: "data:image/svg+xml," + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><rect width="32" height="32" rx="6" fill="#121211"/><path d="M16 6l-10 6h20z" fill="#e5e517"/><rect x="9" y="14" width="3" height="8" rx="0.5" fill="#e5e517"/><rect x="14.5" y="14" width="3" height="8" rx="0.5" fill="#e5e517"/><rect x="20" y="14" width="3" height="8" rx="0.5" fill="#e5e517"/><rect x="7" y="23" width="18" height="2.5" rx="1" fill="#e5e517"/></svg>'),
      // Tarjeta - credit card
      4: "data:image/svg+xml," + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><rect width="32" height="32" rx="6" fill="#121211"/><rect x="5" y="9" width="22" height="14" rx="2.5" fill="none" stroke="#e5e517" stroke-width="2"/><line x1="5" y1="14" x2="27" y2="14" stroke="#e5e517" stroke-width="2.5"/><rect x="8" y="18" width="6" height="2" rx="1" fill="#e5e517"/></svg>'),
      // Cripto - bitcoin symbol
      5: "data:image/svg+xml," + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><rect width="32" height="32" rx="6" fill="#121211"/><circle cx="16" cy="16" r="9" fill="none" stroke="#e5e517" stroke-width="2"/><text x="16" y="21" text-anchor="middle" font-family="Arial,sans-serif" font-weight="700" font-size="14" fill="#e5e517">₿</text></svg>'),
      // Earn - coin/dollar growing
      6: "data:image/svg+xml," + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><rect width="32" height="32" rx="6" fill="#121211"/><circle cx="16" cy="18" r="7" fill="none" stroke="#e5e517" stroke-width="2"/><text x="16" y="22.5" text-anchor="middle" font-family="Arial,sans-serif" font-weight="700" font-size="12" fill="#e5e517">$</text><path d="M16 11V7m-3 2l3-3 3 3" stroke="#e5e517" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>'),
    };
    const SPECIAL_BONUS = 50;

    // ========== GAME CONFIG ==========
    const GRID_SIZE = 8;
    let grid = [];
    let score = 0;
    let bestScore = parseInt(localStorage.getItem('bb_best') || '0');
    let currentPieces = [];
    let draggingPiece = null;
    let floatingEl = null;
    let comboCount = 0;
    let dragOffsetY = 0;
    let gridRect = null;
    let cellSize = 0;
    let currentGameNumber = 0;
    let currentMultiplier = 1.0;

    // Load best score and multiplier
    (async () => {
      try {
        const [remoteBest, mult] = await Promise.all([
          SupabaseUtils.getBestScore(_username),
          SupabaseUtils.getMultiplier(_username),
        ]);
        if (remoteBest > bestScore) {
          bestScore = remoteBest;
          localStorage.setItem('bb_best', bestScore.toString());
          document.getElementById('bestScore').textContent = bestScore.toLocaleString();
        }
        currentMultiplier = mult;
      } catch (e) { /* offline fallback */ }
    })();

    // ========== SOUND ==========
    let audioCtx = null;
    function getAudioCtx() {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      return audioCtx;
    }

    function playTone(freq, duration, type, vol) {
      try {
        const ctx = getAudioCtx();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = type || 'sine';
        osc.frequency.setValueAtTime(freq, ctx.currentTime);
        gain.gain.setValueAtTime(vol || 0.15, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration);
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start();
        osc.stop(ctx.currentTime + duration);
      } catch (e) {}
    }

    function soundPlace() {
      try {
        const ctx = getAudioCtx();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(280, ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(90, ctx.currentTime + 0.08);
        gain.gain.setValueAtTime(0.12, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.1);
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start();
        osc.stop(ctx.currentTime + 0.1);
      } catch (e) {}
    }

    function soundClear(lineCount) {
      playTone(523, 0.12, 'sine', 0.18);
      setTimeout(() => playTone(659, 0.12, 'sine', 0.18), 60);
      setTimeout(() => playTone(784, 0.15, 'sine', 0.2), 120);
      if (lineCount > 1) {
        setTimeout(() => playTone(1047, 0.2, 'sine', 0.22), 180);
      }
    }

    function soundCombo(mult) {
      const base = 600 + mult * 100;
      playTone(base, 0.1, 'sine', 0.15);
      setTimeout(() => playTone(base * 1.25, 0.1, 'sine', 0.18), 80);
      setTimeout(() => playTone(base * 1.5, 0.15, 'triangle', 0.2), 160);
      setTimeout(() => playTone(base * 2, 0.25, 'sine', 0.15), 240);
    }

    function soundGameOver() {
      playTone(400, 0.15, 'sawtooth', 0.1);
      setTimeout(() => playTone(300, 0.15, 'sawtooth', 0.1), 150);
      setTimeout(() => playTone(200, 0.3, 'sawtooth', 0.12), 300);
    }

    // ========== PIECES ==========
    const PIECES = [
      { shape: [[1]] },
      { shape: [[1, 1]] },
      { shape: [[1], [1]] },
      { shape: [[1, 1, 1]] },
      { shape: [[1], [1], [1]] },
      { shape: [[1, 0], [1, 1]] },
      { shape: [[0, 1], [1, 1]] },
      { shape: [[1, 1], [1, 0]] },
      { shape: [[1, 1], [0, 1]] },
      { shape: [[1, 1, 1], [0, 1, 0]] },
      { shape: [[0, 1, 0], [1, 1, 1]] },
      { shape: [[1, 1, 1, 1]] },
      { shape: [[1], [1], [1], [1]] },
      { shape: [[1, 1], [1, 1]] },
      { shape: [[1, 1, 1, 1, 1]] },
      { shape: [[1], [1], [1], [1], [1]] },
      { shape: [[1, 1, 0], [0, 1, 1]] },
      { shape: [[0, 1, 1], [1, 1, 0]] },
      { shape: [[1, 0, 0], [1, 0, 0], [1, 1, 1]] },
      { shape: [[0, 0, 1], [0, 0, 1], [1, 1, 1]] },
      { shape: [[1, 1, 1], [1, 0, 0], [1, 0, 0]] },
      { shape: [[1, 1, 1], [0, 0, 1], [0, 0, 1]] },
      { shape: [[1, 1, 1], [1, 1, 1], [1, 1, 1]] },
    ];

    // ========== UTILITY ==========
    function vibrate(ms) {
      if (navigator.vibrate) navigator.vibrate(ms);
    }

    function cacheGridRect() {
      const gridEl = document.getElementById('grid');
      gridRect = gridEl.getBoundingClientRect();
      cellSize = (gridRect.width - 12) / GRID_SIZE;
    }

    // ========== INIT ==========
    async function init() {
      // Fetch game count for seeded RNG
      currentGameNumber = await SupabaseUtils.getGameCountToday(_username);
      rng = mulberry32(makeSeed(currentGameNumber));

      // Refresh multiplier and update banner
      currentMultiplier = await SupabaseUtils.getMultiplier(_username);
      updateRewardBanner();

      grid = Array.from({ length: GRID_SIZE }, () => Array(GRID_SIZE).fill(0));
      score = 0;
      comboCount = 0;
      updateScore();
      renderGrid();
      spawnPieces();
      document.getElementById('gameOverOverlay').classList.remove('visible');
      setTimeout(cacheGridRect, 50);
    }

    // ========== GRID ==========
    function renderGrid() {
      const gridEl = document.getElementById('grid');
      gridEl.innerHTML = '';
      for (let r = 0; r < GRID_SIZE; r++) {
        for (let c = 0; c < GRID_SIZE; c++) {
          const val = grid[r][c];
          const cell = document.createElement('div');
          if (val >= 2) {
            cell.className = 'cell special';
            const img = document.createElement('img');
            img.src = SPECIAL_ICONS[val];
            img.alt = '';
            cell.appendChild(img);
          } else {
            cell.className = 'cell' + (val ? ' filled' : '');
          }
          cell.dataset.row = r;
          cell.dataset.col = c;
          gridEl.appendChild(cell);
        }
      }
    }

    // ========== PIECES ==========
    function getRandomPiece(allowSpecial) {
      const shape = PIECES[Math.floor(rng() * PIECES.length)].shape;
      let specialCells = null;
      if (allowSpecial && rng() < 0.20) {
        // Pick a random filled cell in the shape
        const filled = [];
        for (let r = 0; r < shape.length; r++)
          for (let c = 0; c < shape[0].length; c++)
            if (shape[r][c]) filled.push({ r, c });
        if (filled.length > 0) {
          const pick = filled[Math.floor(rng() * filled.length)];
          const type = 2 + Math.floor(rng() * 5); // 2-6
          specialCells = [{ r: pick.r, c: pick.c, type }];
        }
      }
      return { shape, used: false, specialCells };
    }

    function spawnPieces() {
      const usedIndices = [];
      currentPieces = [];
      let hasSpecial = false;
      for (let i = 0; i < 3; i++) {
        let idx;
        let attempts = 0;
        do {
          idx = Math.floor(rng() * PIECES.length);
          attempts++;
        } while (usedIndices.includes(idx) && attempts < 20);
        usedIndices.push(idx);
        const piece = getRandomPiece(!hasSpecial);
        piece.shape = PIECES[idx].shape;
        if (piece.specialCells) {
          // Re-validate specialCells against this shape
          const filled = [];
          for (let r = 0; r < piece.shape.length; r++)
            for (let c = 0; c < piece.shape[0].length; c++)
              if (piece.shape[r][c]) filled.push({ r, c });
          if (filled.length > 0 && piece.specialCells.length > 0) {
            const pick = filled[Math.floor(rng() * filled.length)];
            piece.specialCells[0].r = pick.r;
            piece.specialCells[0].c = pick.c;
          }
          hasSpecial = true;
        }
        currentPieces.push(piece);
      }
      renderPieces();
      if (!canPlaceAnyPiece()) setTimeout(gameOver, 300);
    }

    function isSpecialCell(piece, r, c) {
      if (!piece.specialCells) return null;
      const sc = piece.specialCells.find(s => s.r === r && s.c === c);
      return sc || null;
    }

    function renderPieces() {
      const area = document.getElementById('piecesArea');
      area.innerHTML = '';
      currentPieces.forEach((piece, i) => {
        const slot = document.createElement('div');
        slot.className = 'piece-slot' + (piece.used ? ' used' : '');

        if (!piece.used) {
          const rows = piece.shape.length;
          const cols = piece.shape[0].length;
          const pg = document.createElement('div');
          pg.className = 'piece-grid';
          pg.style.gridTemplateColumns = `repeat(${cols}, 16px)`;
          pg.style.gridTemplateRows = `repeat(${rows}, 16px)`;
          for (let r = 0; r < rows; r++) {
            for (let c = 0; c < cols; c++) {
              const cell = document.createElement('div');
              const sc = isSpecialCell(piece, r, c);
              if (sc) {
                cell.className = 'piece-cell special';
                const img = document.createElement('img');
                img.src = SPECIAL_ICONS[sc.type];
                img.alt = '';
                cell.appendChild(img);
              } else {
                cell.className = 'piece-cell ' + (piece.shape[r][c] ? 'active' : 'empty');
              }
              pg.appendChild(cell);
            }
          }
          slot.appendChild(pg);
          slot.addEventListener('touchstart', (e) => startDrag(e, i, true), { passive: false });
          slot.addEventListener('mousedown', (e) => startDrag(e, i, false));
        }
        area.appendChild(slot);
      });
    }

    // ========== DRAG ==========
    function startDrag(e, idx, isTouch) {
      e.preventDefault();
      const piece = currentPieces[idx];
      if (piece.used) return;

      draggingPiece = { index: idx, piece };
      dragOffsetY = isTouch ? 80 : 0;
      cacheGridRect();

      document.querySelectorAll('.piece-slot')[idx].classList.add('dragging');

      const pos = isTouch ? e.touches[0] : e;
      createFloatingPiece(piece, pos.clientX, pos.clientY);

      if (isTouch) {
        const move = (e2) => { e2.preventDefault(); const t = e2.touches[0]; onDragMove(t.clientX, t.clientY, piece); };
        const end = (e2) => { const t = e2.changedTouches[0]; onDragEnd(t.clientX, t.clientY, piece, idx); document.removeEventListener('touchmove', move); document.removeEventListener('touchend', end); };
        document.addEventListener('touchmove', move, { passive: false });
        document.addEventListener('touchend', end);
      } else {
        const move = (e2) => onDragMove(e2.clientX, e2.clientY, piece);
        const end = (e2) => { onDragEnd(e2.clientX, e2.clientY, piece, idx); document.removeEventListener('mousemove', move); document.removeEventListener('mouseup', end); };
        document.addEventListener('mousemove', move);
        document.addEventListener('mouseup', end);
      }
    }

    function onDragMove(x, y, piece) {
      moveFloating(x, y, piece);
      showPreview(x, y, piece);
    }

    function onDragEnd(x, y, piece, idx) {
      clearPreview();
      removeFloating();
      document.querySelectorAll('.piece-slot').forEach(s => s.classList.remove('dragging'));

      const { startRow, startCol } = getPlacement(x, y, piece);

      if (canPlacePiece(piece.shape, startRow, startCol)) {
        placePiece(piece.shape, startRow, startCol, piece.specialCells);
        currentPieces[idx].used = true;
        vibrate(15);
        soundPlace();

        let cells = 0;
        piece.shape.forEach(row => row.forEach(c => { if (c) cells++; }));
        addScore(cells);

        const cleared = checkAndClearLines();
        if (cleared > 0) {
          comboCount++;
          const mult = Math.min(comboCount, 5);
          const pts = cleared * GRID_SIZE * 10 * mult;
          addScore(pts);
          showCombo(mult);
          showScorePopup(pts, x, y - 80);
          vibrate([20, 30, 20]);
          soundClear(cleared);
          if (mult > 1) setTimeout(() => soundCombo(mult), 200);
        } else {
          comboCount = 0;
          hideCombo();
        }

        renderGrid();
        renderPieces();

        if (currentPieces.every(p => p.used)) {
          setTimeout(spawnPieces, 200);
        } else if (!canPlaceAnyPiece()) {
          setTimeout(gameOver, 500);
        }
      }
      draggingPiece = null;
    }

    function createFloatingPiece(piece, x, y) {
      removeFloating();
      const rows = piece.shape.length;
      const cols = piece.shape[0].length;
      // Floating cell size matches grid cell
      const fCellSize = Math.round(cellSize);
      const gap = 3;

      floatingEl = document.createElement('div');
      floatingEl.className = 'floating-piece';
      floatingEl.style.gridTemplateColumns = `repeat(${cols}, ${fCellSize}px)`;
      floatingEl.style.gridTemplateRows = `repeat(${rows}, ${fCellSize}px)`;
      floatingEl.style.gap = gap + 'px';

      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          const cell = document.createElement('div');
          const sc = isSpecialCell(piece, r, c);
          if (sc) {
            cell.className = 'floating-cell special';
            const img = document.createElement('img');
            img.src = SPECIAL_ICONS[sc.type];
            img.alt = '';
            cell.appendChild(img);
          } else {
            cell.className = piece.shape[r][c] ? 'floating-cell' : 'floating-cell empty';
          }
          floatingEl.appendChild(cell);
        }
      }
      document.body.appendChild(floatingEl);
      moveFloating(x, y, piece);
    }

    function moveFloating(x, y, piece) {
      if (!floatingEl) return;
      const rows = piece.shape.length;
      const cols = piece.shape[0].length;
      const fCell = Math.round(cellSize);
      const gap = 3;
      const pw = cols * fCell + (cols - 1) * gap;
      const ph = rows * fCell + (rows - 1) * gap;
      floatingEl.style.left = (x - pw / 2) + 'px';
      floatingEl.style.top = (y - dragOffsetY - ph / 2) + 'px';
    }

    function removeFloating() {
      if (floatingEl) { floatingEl.remove(); floatingEl = null; }
    }

    // ========== GRID POSITION ==========
    function getGridPos(clientX, clientY) {
      if (!gridRect) cacheGridRect();
      const col = Math.floor((clientX - gridRect.left - 6) / cellSize);
      const row = Math.floor((clientY - gridRect.top - 6) / cellSize);
      return { row, col };
    }

    function getPlacement(clientX, clientY, piece) {
      const { row, col } = getGridPos(clientX, clientY - dragOffsetY);
      const rows = piece.shape.length;
      const cols = piece.shape[0].length;
      return {
        startRow: row - Math.floor((rows - 1) / 2),
        startCol: col - Math.floor((cols - 1) / 2)
      };
    }

    function showPreview(clientX, clientY, piece) {
      clearPreview();
      const { startRow, startCol } = getPlacement(clientX, clientY, piece);
      const ok = canPlacePiece(piece.shape, startRow, startCol);

      for (let r = 0; r < piece.shape.length; r++) {
        for (let c = 0; c < piece.shape[0].length; c++) {
          if (!piece.shape[r][c]) continue;
          const gr = startRow + r, gc = startCol + c;
          if (gr < 0 || gr >= GRID_SIZE || gc < 0 || gc >= GRID_SIZE) continue;
          const el = document.querySelector(`.cell[data-row="${gr}"][data-col="${gc}"]`);
          if (el && !grid[gr][gc]) el.classList.add(ok ? 'preview' : 'invalid-preview');
        }
      }
    }

    function clearPreview() {
      document.querySelectorAll('.cell.preview,.cell.invalid-preview').forEach(el => el.classList.remove('preview', 'invalid-preview'));
    }

    // ========== GAME LOGIC ==========
    function canPlacePiece(shape, sr, sc) {
      for (let r = 0; r < shape.length; r++)
        for (let c = 0; c < shape[0].length; c++) {
          if (!shape[r][c]) continue;
          const gr = sr + r, gc = sc + c;
          if (gr < 0 || gr >= GRID_SIZE || gc < 0 || gc >= GRID_SIZE || grid[gr][gc]) return false;
        }
      return true;
    }

    function placePiece(shape, sr, sc, specialCells) {
      for (let r = 0; r < shape.length; r++)
        for (let c = 0; c < shape[0].length; c++) {
          if (!shape[r][c]) continue;
          let val = 1;
          if (specialCells) {
            const sc2 = specialCells.find(s => s.r === r && s.c === c);
            if (sc2) val = sc2.type;
          }
          grid[sr + r][sc + c] = val;
        }
    }

    function spawnParticles(el) {
      const rect = el.getBoundingClientRect();
      const cx = rect.left + rect.width / 2;
      const cy = rect.top + rect.height / 2;
      const colors = ['#e5e517', '#fff', '#eaea43', '#f5f580', '#fffbe6'];
      const count = 10;
      for (let i = 0; i < count; i++) {
        const p = document.createElement('div');
        p.className = 'explosion-particle';
        const size = 4 + Math.random() * 6;
        p.style.width = size + 'px';
        p.style.height = size + 'px';
        p.style.left = cx + 'px';
        p.style.top = cy + 'px';
        p.style.background = colors[Math.floor(Math.random() * colors.length)];
        p.style.boxShadow = '0 0 ' + (size + 2) + 'px ' + p.style.background;
        const angle = (Math.PI * 2 * i) / count + (Math.random() - 0.5) * 0.8;
        const dist = 30 + Math.random() * 50;
        const tx = Math.cos(angle) * dist;
        const ty = Math.sin(angle) * dist;
        const dur = 0.5 + Math.random() * 0.4;
        p.style.setProperty('--tx', tx + 'px');
        p.style.setProperty('--ty', ty + 'px');
        p.style.setProperty('--dur', dur + 's');
        document.body.appendChild(p);
        setTimeout(() => p.remove(), 900);
      }
    }

    function spawnLineFlash(line) {
      const gridEl = document.getElementById('grid');
      const gridR = gridEl.getBoundingClientRect();
      const flash = document.createElement('div');
      flash.className = 'line-flash';
      if (line.type === 'row') {
        const firstCell = document.querySelector(`.cell[data-row="${line.i}"][data-col="0"]`);
        if (!firstCell) return;
        const cr = firstCell.getBoundingClientRect();
        flash.style.left = gridR.left + 'px';
        flash.style.top = cr.top + 'px';
        flash.style.width = gridR.width + 'px';
        flash.style.height = cr.height + 'px';
      } else {
        const firstCell = document.querySelector(`.cell[data-row="0"][data-col="${line.i}"]`);
        if (!firstCell) return;
        const cr = firstCell.getBoundingClientRect();
        flash.style.left = cr.left + 'px';
        flash.style.top = gridR.top + 'px';
        flash.style.width = cr.width + 'px';
        flash.style.height = gridR.height + 'px';
        flash.style.background = 'linear-gradient(180deg, transparent, rgba(229,229,23,0.6), rgba(255,255,255,0.8), rgba(229,229,23,0.6), transparent)';
      }
      document.body.appendChild(flash);
      setTimeout(() => flash.remove(), 550);
    }

    function checkAndClearLines() {
      let lines = [];
      for (let r = 0; r < GRID_SIZE; r++)
        if (grid[r].every(v => v)) lines.push({ type: 'row', i: r });
      for (let c = 0; c < GRID_SIZE; c++) {
        let full = true;
        for (let r = 0; r < GRID_SIZE; r++) if (!grid[r][c]) { full = false; break; }
        if (full) lines.push({ type: 'col', i: c });
      }
      if (!lines.length) return 0;

      // Collect special blocks in cleared lines (deduplicate by r,c)
      const specialSet = new Set();
      const specialBlocks = [];
      lines.forEach(l => {
        for (let i = 0; i < GRID_SIZE; i++) {
          const r = l.type === 'row' ? l.i : i;
          const c = l.type === 'row' ? i : l.i;
          const key = r + ',' + c;
          if (grid[r][c] >= 2 && !specialSet.has(key)) {
            specialSet.add(key);
            specialBlocks.push({ r, c, type: grid[r][c] });
          }
        }
      });

      // Shake the grid
      const gridEl = document.getElementById('grid');
      gridEl.classList.remove('shake');
      void gridEl.offsetWidth;
      gridEl.classList.add('shake');
      setTimeout(() => gridEl.classList.remove('shake'), 450);

      // Flash + particles per line
      lines.forEach(l => {
        spawnLineFlash(l);
        for (let i = 0; i < GRID_SIZE; i++) {
          const el = l.type === 'row'
            ? document.querySelector(`.cell[data-row="${l.i}"][data-col="${i}"]`)
            : document.querySelector(`.cell[data-row="${i}"][data-col="${l.i}"]`);
          if (el) {
            el.classList.add('clearing');
            spawnParticles(el);
          }
        }
      });

      // Special block bonuses
      if (specialBlocks.length > 0) {
        let bonusTotal = 0;
        specialBlocks.forEach((sb, idx) => {
          const el = document.querySelector(`.cell[data-row="${sb.r}"][data-col="${sb.c}"]`);
          if (el) {
            // Extra particles for special blocks
            spawnParticles(el);
            spawnParticles(el);
          }
          const rect = el ? el.getBoundingClientRect() : null;
          const bx = rect ? rect.left + rect.width / 2 : 180;
          const by = rect ? rect.top : 300;
          setTimeout(() => {
            showBonusPopup(SPECIAL_BONUS, bx, by, SPECIAL_ICONS[sb.type]);
          }, idx * 120);
          bonusTotal += SPECIAL_BONUS;
        });
        addScore(bonusTotal);
        soundBonus();
      }

      // Vibrate
      vibrate(lines.length > 1 ? [50, 30, 80] : 40);

      setTimeout(() => {
        lines.forEach(l => {
          for (let i = 0; i < GRID_SIZE; i++) {
            if (l.type === 'row') grid[l.i][i] = 0;
            else grid[i][l.i] = 0;
          }
        });
        renderGrid();
      }, 350);

      return lines.length;
    }

    function canPlaceAnyPiece() {
      for (const p of currentPieces) {
        if (p.used) continue;
        for (let r = 0; r < GRID_SIZE; r++)
          for (let c = 0; c < GRID_SIZE; c++)
            if (canPlacePiece(p.shape, r, c)) return true;
      }
      return false;
    }

    // ========== SCORE ==========
    function addScore(pts) {
      score += pts;
      if (score > bestScore) {
        bestScore = score;
        localStorage.setItem('bb_best', bestScore.toString());
      }
      updateScore();
    }

    function updateScore() {
      document.getElementById('score').textContent = score.toLocaleString();
      document.getElementById('bestScore').textContent = bestScore.toLocaleString();
    }

    function showCombo(m) {
      const el = document.getElementById('combo');
      el.textContent = `COMBO x${m}`;
      el.classList.add('visible');
    }

    function hideCombo() { document.getElementById('combo').classList.remove('visible'); }

    function showScorePopup(pts, x, y) {
      const p = document.createElement('div');
      p.className = 'score-popup';
      p.textContent = `+${pts}`;
      p.style.left = x + 'px';
      p.style.top = y + 'px';
      document.body.appendChild(p);
      setTimeout(() => p.remove(), 800);
    }

    function showBonusPopup(pts, x, y, iconUrl) {
      const p = document.createElement('div');
      p.className = 'bonus-popup';
      if (iconUrl) {
        const img = document.createElement('img');
        img.src = iconUrl;
        img.alt = '';
        p.appendChild(img);
      }
      const txt = document.createElement('span');
      txt.textContent = `+${pts}`;
      p.appendChild(txt);
      p.style.left = (x - 30) + 'px';
      p.style.top = y + 'px';
      document.body.appendChild(p);
      setTimeout(() => p.remove(), 1100);
    }

    async function updateRewardBanner() {
      const banner = document.getElementById('rewardBanner');
      const text = document.getElementById('rewardText');
      try {
        const boosts = await SupabaseUtils.getDailyBoosts(_username);
        const allDone = boosts.question_correct && boosts.shared_link;
        const someDone = boosts.question_correct || boosts.shared_link;
        if (allDone || currentMultiplier > 1) {
          banner.querySelector('.coin').textContent = '\u2B50';
          text.innerHTML = 'Completa una fila o columna con bloques especiales y gana <strong>+50 puntos!</strong>';
        } else if (someDone) {
          text.innerHTML = 'Te falta un booster! Activa todos para obtener <strong>mas puntos!</strong>';
        } else {
          text.innerHTML = 'Activa los boosters en la pantalla principal para <strong>puntuar mas!</strong>';
        }
      } catch (e) {}
    }

    function soundBonus() {
      try {
        const ctx = getAudioCtx();
        // Bling coin sound - two quick ascending tones
        const osc1 = ctx.createOscillator();
        const gain1 = ctx.createGain();
        osc1.type = 'sine';
        osc1.frequency.setValueAtTime(1200, ctx.currentTime);
        osc1.frequency.exponentialRampToValueAtTime(1800, ctx.currentTime + 0.08);
        gain1.gain.setValueAtTime(0.18, ctx.currentTime);
        gain1.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.15);
        osc1.connect(gain1);
        gain1.connect(ctx.destination);
        osc1.start();
        osc1.stop(ctx.currentTime + 0.15);

        const osc2 = ctx.createOscillator();
        const gain2 = ctx.createGain();
        osc2.type = 'triangle';
        osc2.frequency.setValueAtTime(1800, ctx.currentTime + 0.08);
        osc2.frequency.exponentialRampToValueAtTime(2400, ctx.currentTime + 0.18);
        gain2.gain.setValueAtTime(0.001, ctx.currentTime);
        gain2.gain.setValueAtTime(0.15, ctx.currentTime + 0.08);
        gain2.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.25);
        osc2.connect(gain2);
        gain2.connect(ctx.destination);
        osc2.start(ctx.currentTime + 0.08);
        osc2.stop(ctx.currentTime + 0.25);
      } catch (e) {}
    }

    // ========== BACKGROUND MUSIC ==========
    let bgMusicPlaying = false;
    let bgMusicNodes = null;

    function startBgMusic() {
      if (bgMusicPlaying) return;
      try {
        const ctx = getAudioCtx();
        const master = ctx.createGain();
        master.gain.setValueAtTime(0.06, ctx.currentTime);
        master.connect(ctx.destination);

        // Ambient pad - warm low chord
        const notes = [130.81, 164.81, 196.00, 261.63]; // C3, E3, G3, C4
        const oscs = notes.map(freq => {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.type = 'sine';
          osc.frequency.setValueAtTime(freq, ctx.currentTime);
          gain.gain.setValueAtTime(0.15, ctx.currentTime);
          osc.connect(gain);
          gain.connect(master);
          osc.start();
          return { osc, gain };
        });

        // Subtle LFO for movement
        const lfo = ctx.createOscillator();
        const lfoGain = ctx.createGain();
        lfo.type = 'sine';
        lfo.frequency.setValueAtTime(0.3, ctx.currentTime);
        lfoGain.gain.setValueAtTime(3, ctx.currentTime);
        lfo.connect(lfoGain);
        lfoGain.connect(oscs[0].osc.frequency);
        lfo.start();

        bgMusicNodes = { master, oscs, lfo, lfoGain, ctx };
        bgMusicPlaying = true;
      } catch (e) {}
    }

    function stopBgMusic() {
      if (!bgMusicPlaying || !bgMusicNodes) return;
      try {
        const { master, oscs, lfo, lfoGain, ctx } = bgMusicNodes;
        master.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 1);
        setTimeout(() => {
          oscs.forEach(o => { try { o.osc.stop(); } catch(e){} });
          try { lfo.stop(); } catch(e){}
          bgMusicPlaying = false;
          bgMusicNodes = null;
        }, 1200);
      } catch (e) {
        bgMusicPlaying = false;
        bgMusicNodes = null;
      }
    }

    // ========== SCORE COUNTING SOUND ==========
    function soundScoreCount(progress) {
      // Rising pitch as score counts up (progress 0-1)
      try {
        const ctx = getAudioCtx();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'sine';
        const freq = 400 + progress * 800;
        osc.frequency.setValueAtTime(freq, ctx.currentTime);
        gain.gain.setValueAtTime(0.08, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.06);
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start();
        osc.stop(ctx.currentTime + 0.06);
      } catch (e) {}
    }

    function soundBoosterReveal() {
      try {
        const ctx = getAudioCtx();
        // Dramatic reveal sound
        [800, 1000, 1200].forEach((freq, i) => {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.type = 'triangle';
          osc.frequency.setValueAtTime(freq, ctx.currentTime + i * 0.06);
          gain.gain.setValueAtTime(0.15, ctx.currentTime + i * 0.06);
          gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + i * 0.06 + 0.2);
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.start(ctx.currentTime + i * 0.06);
          osc.stop(ctx.currentTime + i * 0.06 + 0.2);
        });
      } catch (e) {}
    }

    function soundScoreFinale() {
      try {
        const ctx = getAudioCtx();
        const freqs = [523, 659, 784, 1047, 1319];
        freqs.forEach((freq, i) => {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.type = i < 3 ? 'sine' : 'triangle';
          osc.frequency.setValueAtTime(freq, ctx.currentTime + i * 0.08);
          gain.gain.setValueAtTime(0.18, ctx.currentTime + i * 0.08);
          gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + i * 0.08 + 0.4);
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.start(ctx.currentTime + i * 0.08);
          osc.stop(ctx.currentTime + i * 0.08 + 0.4);
        });
      } catch (e) {}
    }

    // ========== GAME OVER ==========
    async function gameOver() {
      stopBgMusic();
      vibrate([50, 100, 50]);
      soundGameOver();
      document.getElementById('finalScore').textContent = score.toLocaleString();
      document.getElementById('multiplierAnimation').style.display = 'none';
      document.getElementById('multiplierLabel').textContent = '';
      document.getElementById('multipliedScore').textContent = '';
      document.getElementById('multipliedScore').className = '';
      document.getElementById('gameOverOverlay').classList.add('visible');

      const multiplier = currentMultiplier;
      const finalScore = Math.round(score * multiplier);

      // Submit score first
      if (_username && score > 0) {
        await SupabaseUtils.submitScore(_username, score, multiplier, finalScore).catch(() => {});
      }

      // Fetch top 3 leaderboard
      const medals = ['\u{1F947}', '\u{1F948}', '\u{1F949}'];
      const listEl = document.getElementById('goTop3List');
      listEl.innerHTML = [0,1,2].map(i => `<div class="go-top3-row" style="opacity:0.4;"><span class="go-top3-rank">${medals[i]}</span><span class="go-top3-name">---</span><span class="go-top3-pts">-</span></div>`).join('');
      Promise.all([
        SupabaseUtils.getDailyLeaderboard(3),
        SupabaseUtils.getDailyPosition(_username)
      ]).then(([top3, pos]) => {
        let html = '';
        for (let i = 0; i < 3; i++) {
          const entry = top3[i];
          const isMe = entry && _username && entry.username === _username.toLowerCase();
          if (entry) {
            html += `<div class="go-top3-row${isMe ? ' me' : ''}"><span class="go-top3-rank">${medals[i]}</span><span class="go-top3-name">${entry.username}</span><span class="go-top3-pts">${Number(entry.final_score).toLocaleString()}</span></div>`;
          } else {
            html += `<div class="go-top3-row" style="opacity:0.3;"><span class="go-top3-rank">${medals[i]}</span><span class="go-top3-name">---</span><span class="go-top3-pts">-</span></div>`;
          }
        }
        const inTop3 = top3.slice(0, 3).some(e => e && _username && e.username === _username.toLowerCase());
        if (!inTop3 && pos.rank) {
          html += `<div class="go-top3-row me" style="margin-top:4px;"><span class="go-top3-rank" style="font-size:13px;font-weight:700;color:var(--brand);">#${pos.rank}</span><span class="go-top3-name">${_username}</span><span class="go-top3-pts">${Number(pos.score || finalScore).toLocaleString()}</span></div>`;
        }
        listEl.innerHTML = html;
      }).catch(() => {});

      // Show multiplier animation if boosted
      if (multiplier > 1 && score > 0) {
        const boosts = await SupabaseUtils.getDailyBoosts(_username);
        const reasons = [];
        if (boosts.question_correct) reasons.push({ icon: '\u{1F9E0}', text: 'Pregunta del dia correcta', mult: 'x1.1' });
        if (boosts.shared_link) reasons.push({ icon: '\u{1F91D}', text: 'Link compartido con amigos', mult: 'x1.1' });

        document.getElementById('multiplierAnimation').style.display = 'block';
        const reasonsEl = document.getElementById('boosterReasons');
        reasonsEl.innerHTML = '';

        let delay = 600;

        // Reveal each booster with dramatic animation
        reasons.forEach((r, i) => {
          setTimeout(() => {
            const div = document.createElement('div');
            div.className = 'booster-reason-card';
            div.innerHTML = `<span class="booster-icon">${r.icon}</span><span class="booster-text">${r.text}</span><span class="booster-mult">${r.mult}</span>`;
            reasonsEl.appendChild(div);
            soundBoosterReveal();
            vibrate([20, 30, 40]);
          }, delay + i * 700);
        });

        // Show label + start counting
        const countDelay = delay + reasons.length * 700 + 500;
        setTimeout(() => {
          document.getElementById('multiplierLabel').textContent = 'PUNTAJE FINAL';
          const scoreEl = document.getElementById('multipliedScore');
          scoreEl.className = 'multiplied-score-counting';

          let current = score;
          const totalSteps = 45;
          const step = Math.max(1, Math.floor((finalScore - score) / totalSteps));
          let stepCount = 0;

          const interval = setInterval(() => {
            current += step;
            stepCount++;
            const progress = Math.min(stepCount / totalSteps, 1);

            if (current >= finalScore) {
              current = finalScore;
              clearInterval(interval);
              scoreEl.className = 'multiplied-score-done';
              soundScoreFinale();
              vibrate([30, 50, 30, 50, 60]);
            } else {
              soundScoreCount(progress);
            }
            scoreEl.textContent = current.toLocaleString() + ' pts';
          }, 40);
        }, countDelay);
      }
    }

    // ========== RANKING POPUP ==========
    async function showRankingPopup() {
      const overlay = document.getElementById('rankingOverlay');
      const listEl = document.getElementById('rankingPopupList');
      listEl.innerHTML = '<div style="padding:16px;text-align:center;color:var(--text-secondary);font-size:13px;">Cargando...</div>';
      overlay.classList.add('visible');

      try {
        const prizes = ['10', '6', '4', '3', '2'];
        const medals = ['\u{1F947}', '\u{1F948}', '\u{1F949}', '4\uFE0F\u20E3', '5\uFE0F\u20E3'];
        const [top5, pos] = await Promise.all([
          SupabaseUtils.getDailyLeaderboard(5),
          SupabaseUtils.getDailyPosition(_username)
        ]);

        if (!top5 || top5.length === 0) {
          listEl.innerHTML = '<div style="padding:16px;text-align:center;color:var(--text-secondary);font-size:13px;">Nadie ha jugado hoy. Se el primero!</div>';
          return;
        }

        let html = '';
        for (let i = 0; i < 5; i++) {
          const entry = top5[i];
          const isMe = entry && _username && entry.username === _username.toLowerCase();
          const isGold = i === 0;
          if (entry) {
            html += `<div class="go-top3-row${isMe ? ' me' : ''}${isGold ? ' gold' : ''}">
              <span class="go-top3-rank">${medals[i]}</span>
              <span class="go-top3-name">${entry.username}</span>
              <span class="go-top3-pts">${Number(entry.final_score).toLocaleString()}</span>
              <span style="font-size:11px;font-weight:700;color:#26a17b;font-family:'Archivo Narrow',sans-serif;margin-left:4px;">${prizes[i]} USDT</span>
            </div>`;
          } else {
            html += `<div class="go-top3-row" style="opacity:0.3;">
              <span class="go-top3-rank">${medals[i]}</span>
              <span class="go-top3-name">---</span>
              <span style="font-size:11px;font-weight:700;color:#26a17b;font-family:'Archivo Narrow',sans-serif;">${prizes[i]} USDT</span>
            </div>`;
          }
        }

        const inTop5 = top5.some(e => e && _username && e.username === _username.toLowerCase());
        if (!inTop5 && pos && pos.rank) {
          html += `<div style="text-align:center;padding:4px;color:var(--text-secondary);font-size:11px;letter-spacing:2px;">\u2022 \u2022 \u2022</div>`;
          html += `<div class="go-top3-row me">
            <span class="go-top3-rank" style="font-size:13px;font-weight:700;color:var(--brand);">#${pos.rank}</span>
            <span class="go-top3-name">${_username}</span>
            <span class="go-top3-pts">${Number(pos.score).toLocaleString()}</span>
          </div>`;
        }

        listEl.innerHTML = html;
      } catch (e) {
        listEl.innerHTML = '<div style="padding:16px;text-align:center;color:var(--text-secondary);font-size:13px;">Error al cargar ranking</div>';
      }
    }

    document.getElementById('leaderboardBtn').addEventListener('click', showRankingPopup);
    document.getElementById('closeRankingBtn').addEventListener('click', () => {
      document.getElementById('rankingOverlay').classList.remove('visible');
    });

    // ========== EVENTS ==========
    document.getElementById('startBtn').addEventListener('click', () => {
      document.getElementById('welcomeScreen').classList.add('hidden');
      init();
    });

    document.getElementById('newGameBtn').addEventListener('click', showWelcomeScreen);
    document.getElementById('playAgainBtn').addEventListener('click', showWelcomeScreen);

    document.getElementById('shareBtn').addEventListener('click', () => {
      const text = `Hice ${score.toLocaleString()} puntos en Bloques de Oro de El Dorado! Puedes superarme? \u{1F3C6}\u{1FA99}`;
      navigator.clipboard?.writeText(text).then(() => {
        const btn = document.getElementById('shareBtn');
        const orig = btn.textContent;
        btn.textContent = '\u{2705} COPIADO!';
        setTimeout(() => { btn.textContent = orig; }, 2000);
      }).catch(() => {});
    });

    // Recalculate on resize/orientation
    window.addEventListener('resize', () => setTimeout(cacheGridRect, 100));
    window.addEventListener('orientationchange', () => setTimeout(cacheGridRect, 300));

    // Prevent scroll/bounce on iOS
    document.addEventListener('touchmove', (e) => { if (draggingPiece) e.preventDefault(); }, { passive: false });

    // ========== WELCOME LEADERBOARD ==========
    const WELCOME_PRIZES = ['10', '6', '4', '3', '2'];
    const WELCOME_MEDALS = ['\u{1F947}', '\u{1F948}', '\u{1F949}', '4\uFE0F\u20E3', '5\uFE0F\u20E3'];

    async function loadWelcomeLeaderboard() {
      const listEl = document.getElementById('welcomeLbList');
      listEl.innerHTML = '<div class="welcome-lb-row skeleton"><span class="welcome-lb-rank">&nbsp;</span><span class="welcome-lb-name">&nbsp;</span><span class="welcome-lb-prize">&nbsp;</span></div>';
      try {
        const top5 = await SupabaseUtils.getDailyLeaderboard(5);
        if (!top5 || top5.length === 0) {
          listEl.innerHTML = '<div class="welcome-lb-empty">Ningún jugador aún hoy. Sé el primero!</div>';
          return;
        }
        let html = '';
        for (let i = 0; i < 5; i++) {
          const entry = top5[i];
          const isGold = i === 0;
          if (entry) {
            html += `<div class="welcome-lb-row${isGold ? ' gold' : ''}">
              <span class="welcome-lb-rank">${WELCOME_MEDALS[i]}</span>
              <span class="welcome-lb-name">${entry.username}</span>
              <span class="welcome-lb-score">${Number(entry.final_score).toLocaleString()} pts</span>
              <span class="welcome-lb-prize">${WELCOME_PRIZES[i]} USDT</span>
            </div>`;
          } else {
            html += `<div class="welcome-lb-row" style="opacity:0.3;">
              <span class="welcome-lb-rank">${WELCOME_MEDALS[i]}</span>
              <span class="welcome-lb-name">---</span>
              <span class="welcome-lb-prize">${WELCOME_PRIZES[i]} USDT</span>
            </div>`;
          }
        }
        listEl.innerHTML = html;
      } catch (e) {
        listEl.innerHTML = '<div class="welcome-lb-empty">No se pudo cargar el ranking</div>';
      }
    }

    async function showWelcomeScreen() {
      stopBgMusic();
      await loadWelcomeLeaderboard();
      document.getElementById('gameOverOverlay').classList.remove('visible');
      document.getElementById('welcomeScreen').classList.remove('hidden');
    }

    // Load on page start
    loadWelcomeLeaderboard();

    // Init scores display
    document.getElementById('bestScore').textContent = bestScore.toLocaleString();
  </script>
</body>
</html>
