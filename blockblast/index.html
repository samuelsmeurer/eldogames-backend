<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#121211">
  <title>Block Blast - El Dorado</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Archivo+Narrow:wght@400;700&family=Geist:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; }

    :root {
      --bg: #121211;
      --surface: #1a1a19;
      --surface-secondary: #2a2a28;
      --text-primary: #fcfcfc;
      --text-secondary: #b9b9b3;
      --brand: #e5e517;
      --brand-light: #eaea43;
      --brand-glow: rgba(229, 229, 23, 0.15);
      --brand-glow-strong: rgba(229, 229, 23, 0.3);
      --stroke-secondary: #2a2a28;
      --stroke-brand: #e5e517;
      --danger: #e54017;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    html, body {
      background: var(--bg);
      color: var(--text-primary);
      font-family: 'Geist', -apple-system, sans-serif;
      height: 100%;
      overflow: hidden;
      touch-action: none;
      position: fixed;
      width: 100%;
    }

    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: var(--safe-top);
      padding-bottom: var(--safe-bottom);
    }

    .app {
      width: 100%;
      max-width: 430px;
      height: 100%;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }

    /* ========== TOP BAR ========== */
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      border-bottom: 1px solid var(--stroke-secondary);
      flex-shrink: 0;
    }

    .top-bar-logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      background: var(--brand);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo-icon svg { width: 20px; height: 20px; }

    .top-bar-title {
      font-family: 'Archivo Narrow', sans-serif;
      font-weight: 700;
      font-size: 18px;
      letter-spacing: 1.5px;
    }

    .ranking-btn {
      font-family: 'Archivo Narrow', sans-serif;
      font-weight: 700;
      font-size: 12px;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      background: var(--surface-secondary);
      color: var(--text-primary);
      border: 1px solid var(--stroke-secondary);
      border-radius: 8px;
      padding: 8px 14px;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    /* ========== SCORE AREA ========== */
    .score-area {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      flex-shrink: 0;
    }

    .score-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }

    .score-label {
      font-size: 10px;
      font-weight: 700;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 2px;
      font-family: 'Archivo Narrow', sans-serif;
    }

    .score-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--brand);
      font-family: 'Geist', sans-serif;
      line-height: 1;
    }

    .score-value.best {
      color: var(--text-primary);
      font-size: 22px;
    }

    .combo-indicator {
      background: var(--brand-glow);
      border: 1px solid var(--brand);
      border-radius: 20px;
      padding: 6px 16px;
      font-size: 13px;
      font-weight: 700;
      color: var(--brand);
      font-family: 'Archivo Narrow', sans-serif;
      letter-spacing: 1.5px;
      opacity: 0;
      transition: opacity 0.3s, transform 0.3s;
      transform: scale(0.8);
    }

    .combo-indicator.visible {
      opacity: 1;
      transform: scale(1);
    }

    /* ========== REWARD BANNER ========== */
    .reward-banner {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 0 16px 8px;
      padding: 8px 12px;
      background: var(--brand-glow);
      border: 1px solid rgba(229, 229, 23, 0.25);
      border-radius: 10px;
      flex-shrink: 0;
    }

    .reward-banner .coin {
      font-size: 20px;
      flex-shrink: 0;
    }

    .reward-banner .reward-text {
      font-size: 12px;
      color: var(--text-secondary);
      line-height: 1.3;
    }

    .reward-banner .reward-text strong {
      color: var(--brand);
    }

    /* ========== GRID ========== */
    .grid-wrapper {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 12px;
      min-height: 0;
    }

    .grid-container {
      position: relative;
      width: 100%;
      max-width: 360px;
      aspect-ratio: 1;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      grid-template-rows: repeat(8, 1fr);
      gap: 3px;
      width: 100%;
      height: 100%;
      background: var(--surface);
      border-radius: 10px;
      padding: 6px;
      border: 1px solid var(--stroke-secondary);
    }

    .cell {
      background: var(--surface-secondary);
      border-radius: 3px;
      transition: background 0.12s, transform 0.12s, box-shadow 0.12s;
    }

    .cell.filled {
      background: var(--brand);
      box-shadow: inset 0 -2px 0 rgba(0,0,0,0.25), 0 0 8px var(--brand-glow);
    }

    .cell.preview {
      background: rgba(229, 229, 23, 0.3);
      box-shadow: inset 0 0 0 1.5px rgba(229, 229, 23, 0.5);
    }

    .cell.invalid-preview {
      background: rgba(229, 64, 23, 0.2);
      box-shadow: inset 0 0 0 1.5px rgba(229, 64, 23, 0.4);
    }

    .cell.clearing {
      animation: clearPulse 0.4s ease-out;
    }

    @keyframes clearPulse {
      0% { background: var(--brand); transform: scale(1.1); }
      40% { background: #fff; transform: scale(1.15); }
      100% { background: var(--surface-secondary); transform: scale(1); }
    }

    /* ========== PIECES ========== */
    .pieces-area {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      padding: 12px;
      flex-shrink: 0;
    }

    .piece-slot {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100px;
      height: 100px;
      background: var(--surface);
      border-radius: 10px;
      border: 1px solid var(--stroke-secondary);
      cursor: grab;
      transition: transform 0.2s, opacity 0.3s;
    }

    .piece-slot:active { cursor: grabbing; }
    .piece-slot.dragging { opacity: 0.3; transform: scale(0.85); }
    .piece-slot.used { opacity: 0.1; pointer-events: none; }

    .piece-grid { display: grid; gap: 2px; }

    .piece-cell {
      width: 16px;
      height: 16px;
      border-radius: 2px;
    }

    .piece-cell.active {
      background: var(--brand);
      box-shadow: inset 0 -1px 0 rgba(0,0,0,0.2);
    }

    .piece-cell.empty { background: transparent; }

    /* ========== FLOATING PIECE ========== */
    .floating-piece {
      position: fixed;
      pointer-events: none;
      z-index: 100;
      display: grid;
      gap: 3px;
      opacity: 0.85;
      filter: drop-shadow(0 4px 12px rgba(229, 229, 23, 0.3));
    }

    .floating-cell {
      border-radius: 3px;
      background: var(--brand);
      box-shadow: inset 0 -2px 0 rgba(0,0,0,0.25);
    }

    .floating-cell.empty { background: transparent; box-shadow: none; }

    /* ========== BOTTOM BAR ========== */
    .bottom-bar {
      display: flex;
      justify-content: center;
      padding: 8px 16px 12px;
      flex-shrink: 0;
    }

    .btn {
      font-family: 'Archivo Narrow', sans-serif;
      font-weight: 700;
      font-size: 14px;
      letter-spacing: 2px;
      text-transform: uppercase;
      border: none;
      border-radius: 8px;
      padding: 12px 28px;
      cursor: pointer;
      transition: transform 0.1s;
    }

    .btn:active { transform: scale(0.96); }
    .btn-primary { background: var(--brand); color: var(--bg); }
    .btn-secondary { background: var(--surface-secondary); color: var(--text-primary); border: 1px solid var(--stroke-secondary); }

    /* ========== OVERLAYS ========== */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(18, 18, 17, 0.94);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 200;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s;
    }

    .overlay.visible { opacity: 1; pointer-events: all; }

    .overlay-card {
      background: var(--surface);
      border: 1px solid var(--stroke-secondary);
      border-radius: 20px;
      padding: 32px 28px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      width: 320px;
      max-width: 90vw;
    }

    .overlay-emoji { font-size: 48px; line-height: 1; }

    .overlay-title {
      font-family: 'Archivo Narrow', sans-serif;
      font-size: 26px;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      text-align: center;
    }

    .overlay-score {
      font-size: 64px;
      font-weight: 700;
      color: var(--brand);
      line-height: 1;
    }

    .overlay-reward {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--brand-glow);
      border: 1px solid rgba(229, 229, 23, 0.3);
      border-radius: 12px;
      padding: 10px 16px;
      width: 100%;
      justify-content: center;
    }

    .overlay-reward-text {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .overlay-reward-text strong {
      color: var(--brand);
      font-weight: 700;
    }

    .go-top3 { width: 100%; }
    .go-top3-label { font-size: 10px; color: var(--text-secondary); font-family: 'Archivo Narrow', sans-serif; text-transform: uppercase; letter-spacing: 1.5px; text-align: center; margin-bottom: 8px; }
    .go-top3-list { display: flex; flex-direction: column; gap: 4px; }
    .go-top3-row { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: rgba(255,255,255,0.04); border-radius: 8px; border: 1px solid transparent; }
    .go-top3-row.me { background: rgba(229,229,23,0.1); border-color: rgba(229,229,23,0.25); }
    .go-top3-rank { font-size: 16px; width: 24px; text-align: center; flex-shrink: 0; }
    .go-top3-name { flex: 1; font-size: 13px; font-weight: 600; color: var(--text-primary); font-family: 'Geist', sans-serif; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .go-top3-pts { font-size: 13px; font-weight: 700; color: var(--text-secondary); font-family: 'Archivo Narrow', sans-serif; flex-shrink: 0; }
    .go-top3-row.me .go-top3-name, .go-top3-row.me .go-top3-pts { color: var(--brand); }

    .overlay-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 100%;
    }

    .overlay-buttons .btn {
      width: 100%;
      padding: 14px;
      font-size: 15px;
    }

    /* ========== WELCOME SCREEN ========== */
    .welcome-screen {
      position: fixed;
      inset: 0;
      background: var(--bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 300;
      transition: opacity 0.5s;
      gap: 24px;
      padding: 40px;
    }

    .welcome-screen.hidden { opacity: 0; pointer-events: none; }

    .welcome-logo {
      width: 72px;
      height: 72px;
      background: var(--brand);
      border-radius: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 40px var(--brand-glow-strong);
    }

    .welcome-logo svg { width: 44px; height: 44px; }

    .welcome-title {
      font-family: 'Archivo Narrow', sans-serif;
      font-size: 36px;
      font-weight: 700;
      letter-spacing: 3px;
      text-transform: uppercase;
      text-align: center;
    }

    .welcome-subtitle {
      font-size: 15px;
      color: var(--text-secondary);
      text-align: center;
      line-height: 1.5;
      max-width: 280px;
    }

    .welcome-subtitle strong { color: var(--brand); }

    .welcome-crypto-icons {
      display: flex;
      gap: 16px;
      margin: 8px 0;
    }

    .crypto-chip {
      background: var(--surface-secondary);
      border: 1px solid var(--stroke-secondary);
      border-radius: 20px;
      padding: 6px 14px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .crypto-chip .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .dot-usdt { background: #26a17b; }
    .dot-btc { background: #f7931a; }
    .dot-eth { background: #627eea; }

    .welcome-btn {
      width: 100%;
      max-width: 300px;
      padding: 16px;
      font-size: 16px;
      margin-top: 8px;
    }

    .welcome-powered {
      font-size: 11px;
      color: var(--text-secondary);
      opacity: 0.5;
      letter-spacing: 1px;
      font-family: 'Archivo Narrow', sans-serif;
    }

    /* ========== SCORE POPUP ========== */
    .score-popup {
      position: fixed;
      pointer-events: none;
      z-index: 150;
      font-family: 'Archivo Narrow', sans-serif;
      font-weight: 700;
      font-size: 28px;
      color: var(--brand);
      text-shadow: 0 0 12px var(--brand-glow-strong);
      animation: scoreFloat 0.8s ease-out forwards;
    }

    @keyframes scoreFloat {
      0% { opacity: 1; transform: translateY(0) scale(1); }
      100% { opacity: 0; transform: translateY(-70px) scale(1.4); }
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ========== ANIMATIONS ========== */
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .home-indicator {
      width: 134px;
      height: 5px;
      background: var(--text-primary);
      border-radius: 3px;
      opacity: 0.15;
      margin-bottom: 4px;
      flex-shrink: 0;
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Top Bar -->
    <div class="top-bar">
      <div class="top-bar-logo">
        <div class="logo-icon">
          <svg viewBox="0 0 24 24" fill="none">
            <rect x="3" y="3" width="18" height="18" rx="3" fill="#121211"/>
            <text x="12" y="17" text-anchor="middle" font-family="Archivo Narrow" font-weight="700" font-size="15" fill="#e5e517">ED</text>
          </svg>
        </div>
        <span class="top-bar-title">BLOCK BLAST</span>
      </div>
      <button class="ranking-btn" id="leaderboardBtn">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 20V10M18 20V4M6 20v-4"/></svg>
        RANKING
      </button>
    </div>

    <!-- Score Area -->
    <div class="score-area">
      <div class="score-box">
        <span class="score-label">Puntos</span>
        <span class="score-value" id="score">0</span>
      </div>
      <div class="combo-indicator" id="combo">COMBO x2</div>
      <div class="score-box">
        <span class="score-label">Mejor</span>
        <span class="score-value best" id="bestScore">0</span>
      </div>
    </div>

    <!-- Reward Banner -->
    <div class="reward-banner">
      <span class="coin">&#x1FA99;</span>
      <span class="reward-text">Top 5 diario gana recompensas en <strong>USDT, BTC o ETH</strong></span>
    </div>

    <!-- Grid -->
    <div class="grid-wrapper">
      <div class="grid-container">
        <div class="grid" id="grid"></div>
      </div>
    </div>

    <!-- Pieces -->
    <div class="pieces-area" id="piecesArea"></div>

    <!-- Bottom -->
    <div class="bottom-bar">
      <button class="btn btn-secondary" id="newGameBtn">NUEVO JUEGO</button>
    </div>

    <div class="home-indicator"></div>
  </div>

  <!-- Welcome Screen -->
  <div class="welcome-screen" id="welcomeScreen">
    <div class="welcome-logo">
      <svg viewBox="0 0 24 24" fill="none">
        <text x="12" y="18" text-anchor="middle" font-family="Archivo Narrow" font-weight="700" font-size="16" fill="#121211">ED</text>
      </svg>
    </div>
    <div class="welcome-title">Block Blast</div>
    <div class="welcome-subtitle">
      Juega, compite y gana <strong>recompensas en cripto</strong> de verdad. Top 5 diario recibe premios.
    </div>
    <div class="welcome-crypto-icons">
      <div class="crypto-chip"><span class="dot dot-usdt"></span> USDT</div>
      <div class="crypto-chip"><span class="dot dot-btc"></span> BTC</div>
      <div class="crypto-chip"><span class="dot dot-eth"></span> ETH</div>
    </div>
    <button class="btn btn-primary welcome-btn" id="startBtn">JUGAR AHORA</button>
    <div class="welcome-powered">POWERED BY EL DORADO</div>
  </div>

  <!-- Game Over -->
  <div class="overlay" id="gameOverOverlay">
    <div class="overlay-card">
      <div class="overlay-emoji">&#x1F3C6;</div>
      <div class="overlay-title">Juego Terminado</div>
      <div class="overlay-score" id="finalScore">0</div>
      <div id="multiplierAnimation" style="display:none;text-align:center;margin:12px 0;">
        <div id="boosterReasons" style="display:flex;flex-direction:column;gap:6px;margin-bottom:10px;"></div>
        <div id="multipliedScore" style="font-family:'Archivo Narrow',sans-serif;font-weight:700;font-size:56px;color:#1fcc4b;text-shadow:0 0 20px rgba(31,204,75,0.4);"></div>
      </div>
      <div class="go-top3" id="goTop3">
        <div class="go-top3-label">RANKING DEL D&Iacute;A</div>
        <div class="go-top3-list" id="goTop3List"></div>
      </div>
      <div class="overlay-buttons">
        <button class="btn btn-primary" id="playAgainBtn">JUGAR DE NUEVO</button>
        <button class="btn btn-secondary" id="shareBtn">COMPARTE TU PUNTAJE CON AMIGOS</button>
      </div>
    </div>
  </div>

  <script src="/js/supabase-utils.js"></script>
  <script>
    // ========== AUTH CHECK ==========
    if (!SupabaseUtils.getCurrentUsername()) {
      window.location.href = '/username.html';
    }
    const _username = SupabaseUtils.getCurrentUsername();

    // ========== GAME CONFIG ==========
    const GRID_SIZE = 8;
    let grid = [];
    let score = 0;
    let bestScore = parseInt(localStorage.getItem('bb_best') || '0');
    let currentPieces = [];
    let draggingPiece = null;
    let floatingEl = null;
    let comboCount = 0;
    let dragOffsetY = 0;
    let gridRect = null;
    let cellSize = 0;

    // Load best score from Supabase
    (async () => {
      try {
        const remoteBest = await SupabaseUtils.getBestScore(_username, 'block_blast');
        if (remoteBest > bestScore) {
          bestScore = remoteBest;
          localStorage.setItem('bb_best', bestScore.toString());
          document.getElementById('bestScore').textContent = bestScore.toLocaleString();
        }
      } catch (e) { /* offline fallback */ }
    })();

    // ========== PIECES ==========
    const PIECES = [
      { shape: [[1]] },
      { shape: [[1, 1]] },
      { shape: [[1], [1]] },
      { shape: [[1, 1, 1]] },
      { shape: [[1], [1], [1]] },
      { shape: [[1, 0], [1, 1]] },
      { shape: [[0, 1], [1, 1]] },
      { shape: [[1, 1], [1, 0]] },
      { shape: [[1, 1], [0, 1]] },
      { shape: [[1, 1, 1], [0, 1, 0]] },
      { shape: [[0, 1, 0], [1, 1, 1]] },
      { shape: [[1, 1, 1, 1]] },
      { shape: [[1], [1], [1], [1]] },
      { shape: [[1, 1], [1, 1]] },
      { shape: [[1, 1, 1, 1, 1]] },
      { shape: [[1], [1], [1], [1], [1]] },
      { shape: [[1, 1, 0], [0, 1, 1]] },
      { shape: [[0, 1, 1], [1, 1, 0]] },
      { shape: [[1, 0, 0], [1, 0, 0], [1, 1, 1]] },
      { shape: [[0, 0, 1], [0, 0, 1], [1, 1, 1]] },
      { shape: [[1, 1, 1], [1, 0, 0], [1, 0, 0]] },
      { shape: [[1, 1, 1], [0, 0, 1], [0, 0, 1]] },
      { shape: [[1, 1, 1], [1, 1, 1], [1, 1, 1]] },
    ];

    // ========== UTILITY ==========
    function vibrate(ms) {
      if (navigator.vibrate) navigator.vibrate(ms);
    }

    function cacheGridRect() {
      const gridEl = document.getElementById('grid');
      gridRect = gridEl.getBoundingClientRect();
      cellSize = (gridRect.width - 12) / GRID_SIZE; // 6px padding each side
    }

    // ========== INIT ==========
    function init() {
      grid = Array.from({ length: GRID_SIZE }, () => Array(GRID_SIZE).fill(0));
      score = 0;
      comboCount = 0;
      updateScore();
      renderGrid();
      spawnPieces();
      document.getElementById('gameOverOverlay').classList.remove('visible');
      setTimeout(cacheGridRect, 50);
    }

    // ========== GRID ==========
    function renderGrid() {
      const gridEl = document.getElementById('grid');
      gridEl.innerHTML = '';
      for (let r = 0; r < GRID_SIZE; r++) {
        for (let c = 0; c < GRID_SIZE; c++) {
          const cell = document.createElement('div');
          cell.className = 'cell' + (grid[r][c] ? ' filled' : '');
          cell.dataset.row = r;
          cell.dataset.col = c;
          gridEl.appendChild(cell);
        }
      }
    }

    // ========== PIECES ==========
    function getRandomPiece() {
      return { shape: PIECES[Math.floor(Math.random() * PIECES.length)].shape, used: false };
    }

    function spawnPieces() {
      currentPieces = [getRandomPiece(), getRandomPiece(), getRandomPiece()];
      renderPieces();
      if (!canPlaceAnyPiece()) setTimeout(gameOver, 300);
    }

    function renderPieces() {
      const area = document.getElementById('piecesArea');
      area.innerHTML = '';
      currentPieces.forEach((piece, i) => {
        const slot = document.createElement('div');
        slot.className = 'piece-slot' + (piece.used ? ' used' : '');

        if (!piece.used) {
          const rows = piece.shape.length;
          const cols = piece.shape[0].length;
          const pg = document.createElement('div');
          pg.className = 'piece-grid';
          pg.style.gridTemplateColumns = `repeat(${cols}, 16px)`;
          pg.style.gridTemplateRows = `repeat(${rows}, 16px)`;
          for (let r = 0; r < rows; r++) {
            for (let c = 0; c < cols; c++) {
              const cell = document.createElement('div');
              cell.className = 'piece-cell ' + (piece.shape[r][c] ? 'active' : 'empty');
              pg.appendChild(cell);
            }
          }
          slot.appendChild(pg);
          slot.addEventListener('touchstart', (e) => startDrag(e, i, true), { passive: false });
          slot.addEventListener('mousedown', (e) => startDrag(e, i, false));
        }
        area.appendChild(slot);
      });
    }

    // ========== DRAG ==========
    function startDrag(e, idx, isTouch) {
      e.preventDefault();
      const piece = currentPieces[idx];
      if (piece.used) return;

      draggingPiece = { index: idx, piece };
      dragOffsetY = isTouch ? 80 : 0;
      cacheGridRect();

      document.querySelectorAll('.piece-slot')[idx].classList.add('dragging');

      const pos = isTouch ? e.touches[0] : e;
      createFloatingPiece(piece, pos.clientX, pos.clientY);

      if (isTouch) {
        const move = (e2) => { e2.preventDefault(); const t = e2.touches[0]; onDragMove(t.clientX, t.clientY, piece); };
        const end = (e2) => { const t = e2.changedTouches[0]; onDragEnd(t.clientX, t.clientY, piece, idx); document.removeEventListener('touchmove', move); document.removeEventListener('touchend', end); };
        document.addEventListener('touchmove', move, { passive: false });
        document.addEventListener('touchend', end);
      } else {
        const move = (e2) => onDragMove(e2.clientX, e2.clientY, piece);
        const end = (e2) => { onDragEnd(e2.clientX, e2.clientY, piece, idx); document.removeEventListener('mousemove', move); document.removeEventListener('mouseup', end); };
        document.addEventListener('mousemove', move);
        document.addEventListener('mouseup', end);
      }
    }

    function onDragMove(x, y, piece) {
      moveFloating(x, y, piece);
      showPreview(x, y, piece);
    }

    function onDragEnd(x, y, piece, idx) {
      clearPreview();
      removeFloating();
      document.querySelectorAll('.piece-slot').forEach(s => s.classList.remove('dragging'));

      const { startRow, startCol } = getPlacement(x, y, piece);

      if (canPlacePiece(piece.shape, startRow, startCol)) {
        placePiece(piece.shape, startRow, startCol);
        currentPieces[idx].used = true;
        vibrate(15);

        let cells = 0;
        piece.shape.forEach(row => row.forEach(c => { if (c) cells++; }));
        addScore(cells);

        const cleared = checkAndClearLines();
        if (cleared > 0) {
          comboCount++;
          const mult = Math.min(comboCount, 5);
          const pts = cleared * GRID_SIZE * 10 * mult;
          addScore(pts);
          showCombo(mult);
          showScorePopup(pts, x, y - 80);
          vibrate([20, 30, 20]);
        } else {
          comboCount = 0;
          hideCombo();
        }

        renderGrid();
        renderPieces();

        if (currentPieces.every(p => p.used)) {
          setTimeout(spawnPieces, 200);
        } else if (!canPlaceAnyPiece()) {
          setTimeout(gameOver, 500);
        }
      }
      draggingPiece = null;
    }

    function createFloatingPiece(piece, x, y) {
      removeFloating();
      const rows = piece.shape.length;
      const cols = piece.shape[0].length;
      // Floating cell size matches grid cell
      const fCellSize = Math.round(cellSize);
      const gap = 3;

      floatingEl = document.createElement('div');
      floatingEl.className = 'floating-piece';
      floatingEl.style.gridTemplateColumns = `repeat(${cols}, ${fCellSize}px)`;
      floatingEl.style.gridTemplateRows = `repeat(${rows}, ${fCellSize}px)`;
      floatingEl.style.gap = gap + 'px';

      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          const cell = document.createElement('div');
          cell.className = piece.shape[r][c] ? 'floating-cell' : 'floating-cell empty';
          floatingEl.appendChild(cell);
        }
      }
      document.body.appendChild(floatingEl);
      moveFloating(x, y, piece);
    }

    function moveFloating(x, y, piece) {
      if (!floatingEl) return;
      const rows = piece.shape.length;
      const cols = piece.shape[0].length;
      const fCell = Math.round(cellSize);
      const gap = 3;
      const pw = cols * fCell + (cols - 1) * gap;
      const ph = rows * fCell + (rows - 1) * gap;
      floatingEl.style.left = (x - pw / 2) + 'px';
      floatingEl.style.top = (y - dragOffsetY - ph / 2) + 'px';
    }

    function removeFloating() {
      if (floatingEl) { floatingEl.remove(); floatingEl = null; }
    }

    // ========== GRID POSITION ==========
    function getGridPos(clientX, clientY) {
      if (!gridRect) cacheGridRect();
      const col = Math.floor((clientX - gridRect.left - 6) / cellSize);
      const row = Math.floor((clientY - gridRect.top - 6) / cellSize);
      return { row, col };
    }

    function getPlacement(clientX, clientY, piece) {
      const { row, col } = getGridPos(clientX, clientY - dragOffsetY);
      const rows = piece.shape.length;
      const cols = piece.shape[0].length;
      return {
        startRow: row - Math.floor((rows - 1) / 2),
        startCol: col - Math.floor((cols - 1) / 2)
      };
    }

    function showPreview(clientX, clientY, piece) {
      clearPreview();
      const { startRow, startCol } = getPlacement(clientX, clientY, piece);
      const ok = canPlacePiece(piece.shape, startRow, startCol);

      for (let r = 0; r < piece.shape.length; r++) {
        for (let c = 0; c < piece.shape[0].length; c++) {
          if (!piece.shape[r][c]) continue;
          const gr = startRow + r, gc = startCol + c;
          if (gr < 0 || gr >= GRID_SIZE || gc < 0 || gc >= GRID_SIZE) continue;
          const el = document.querySelector(`.cell[data-row="${gr}"][data-col="${gc}"]`);
          if (el && !grid[gr][gc]) el.classList.add(ok ? 'preview' : 'invalid-preview');
        }
      }
    }

    function clearPreview() {
      document.querySelectorAll('.cell.preview,.cell.invalid-preview').forEach(el => el.classList.remove('preview', 'invalid-preview'));
    }

    // ========== GAME LOGIC ==========
    function canPlacePiece(shape, sr, sc) {
      for (let r = 0; r < shape.length; r++)
        for (let c = 0; c < shape[0].length; c++) {
          if (!shape[r][c]) continue;
          const gr = sr + r, gc = sc + c;
          if (gr < 0 || gr >= GRID_SIZE || gc < 0 || gc >= GRID_SIZE || grid[gr][gc]) return false;
        }
      return true;
    }

    function placePiece(shape, sr, sc) {
      for (let r = 0; r < shape.length; r++)
        for (let c = 0; c < shape[0].length; c++)
          if (shape[r][c]) grid[sr + r][sc + c] = 1;
    }

    function checkAndClearLines() {
      let lines = [];
      for (let r = 0; r < GRID_SIZE; r++)
        if (grid[r].every(v => v)) lines.push({ type: 'row', i: r });
      for (let c = 0; c < GRID_SIZE; c++) {
        let full = true;
        for (let r = 0; r < GRID_SIZE; r++) if (!grid[r][c]) { full = false; break; }
        if (full) lines.push({ type: 'col', i: c });
      }
      if (!lines.length) return 0;

      lines.forEach(l => {
        for (let i = 0; i < GRID_SIZE; i++) {
          const el = l.type === 'row'
            ? document.querySelector(`.cell[data-row="${l.i}"][data-col="${i}"]`)
            : document.querySelector(`.cell[data-row="${i}"][data-col="${l.i}"]`);
          if (el) el.classList.add('clearing');
        }
      });

      setTimeout(() => {
        lines.forEach(l => {
          for (let i = 0; i < GRID_SIZE; i++) {
            if (l.type === 'row') grid[l.i][i] = 0;
            else grid[i][l.i] = 0;
          }
        });
        renderGrid();
      }, 350);

      return lines.length;
    }

    function canPlaceAnyPiece() {
      for (const p of currentPieces) {
        if (p.used) continue;
        for (let r = 0; r < GRID_SIZE; r++)
          for (let c = 0; c < GRID_SIZE; c++)
            if (canPlacePiece(p.shape, r, c)) return true;
      }
      return false;
    }

    // ========== SCORE ==========
    function addScore(pts) {
      score += pts;
      if (score > bestScore) {
        bestScore = score;
        localStorage.setItem('bb_best', bestScore.toString());
      }
      updateScore();
    }

    function updateScore() {
      document.getElementById('score').textContent = score.toLocaleString();
      document.getElementById('bestScore').textContent = bestScore.toLocaleString();
    }

    function showCombo(m) {
      const el = document.getElementById('combo');
      el.textContent = `COMBO x${m}`;
      el.classList.add('visible');
    }

    function hideCombo() { document.getElementById('combo').classList.remove('visible'); }

    function showScorePopup(pts, x, y) {
      const p = document.createElement('div');
      p.className = 'score-popup';
      p.textContent = `+${pts}`;
      p.style.left = x + 'px';
      p.style.top = y + 'px';
      document.body.appendChild(p);
      setTimeout(() => p.remove(), 800);
    }

    // ========== GAME OVER ==========
    function gameOver() {
      vibrate([50, 100, 50]);
      document.getElementById('finalScore').textContent = score.toLocaleString();
      document.getElementById('multiplierAnimation').style.display = 'none';
      document.getElementById('gameOverOverlay').classList.add('visible');

      const multiplier = SupabaseUtils.getMultiplier();
      const finalScore = Math.round(score * multiplier);

      // Fetch top 3 leaderboard
      const medals = ['\u{1F947}', '\u{1F948}', '\u{1F949}'];
      const listEl = document.getElementById('goTop3List');
      listEl.innerHTML = [0,1,2].map(i => `<div class="go-top3-row" style="opacity:0.4;"><span class="go-top3-rank">${medals[i]}</span><span class="go-top3-name">---</span><span class="go-top3-pts">-</span></div>`).join('');
      Promise.all([
        SupabaseUtils.getDailyLeaderboard('block_blast', 3),
        SupabaseUtils.getDailyPosition(_username, 'block_blast')
      ]).then(([top3, pos]) => {
        let html = '';
        for (let i = 0; i < 3; i++) {
          const entry = top3[i];
          const isMe = entry && _username && entry.username === _username.toLowerCase();
          if (entry) {
            html += `<div class="go-top3-row${isMe ? ' me' : ''}"><span class="go-top3-rank">${medals[i]}</span><span class="go-top3-name">${entry.username}</span><span class="go-top3-pts">${Number(entry.score).toLocaleString()}</span></div>`;
          } else {
            html += `<div class="go-top3-row" style="opacity:0.3;"><span class="go-top3-rank">${medals[i]}</span><span class="go-top3-name">---</span><span class="go-top3-pts">-</span></div>`;
          }
        }
        const inTop3 = top3.slice(0, 3).some(e => e && _username && e.username === _username.toLowerCase());
        if (!inTop3 && pos.rank) {
          html += `<div class="go-top3-row me" style="margin-top:4px;"><span class="go-top3-rank" style="font-size:13px;font-weight:700;color:var(--brand);">#${pos.rank}</span><span class="go-top3-name">${_username}</span><span class="go-top3-pts">${Number(pos.score || finalScore).toLocaleString()}</span></div>`;
        }
        listEl.innerHTML = html;
      }).catch(() => {});

      if (multiplier > 1 && score > 0) {
        const state = SupabaseUtils.getBoosterState();
        const reasons = [];
        if (state.question) reasons.push({ icon: '\u{1F9E0}', text: 'Pregunta del dia correcta' });
        if (state.tarjeta) reasons.push({ icon: '\u{1F4B3}', text: '$10 gastados en tarjeta' });
        if (state.compra) reasons.push({ icon: '\u{1F4B0}', text: '10 USDT comprados hoy' });
        if (state.referral) reasons.push({ icon: '\u{1F91D}', text: '1 amigo cre\u{00F3} cuenta hoy' });

        document.getElementById('multiplierAnimation').style.display = 'block';
        const reasonsEl = document.getElementById('boosterReasons');
        reasonsEl.innerHTML = '';

        let delay = 500;
        reasons.forEach((r, i) => {
          setTimeout(() => {
            const div = document.createElement('div');
            div.style.cssText = 'display:flex;align-items:center;justify-content:center;gap:6px;padding:6px 12px;background:rgba(229,229,23,0.1);border:1px solid rgba(229,229,23,0.2);border-radius:8px;animation:fadeInUp 0.4s ease-out;';
            div.innerHTML = `<span style="font-size:14px;">${r.icon}</span><span style="font-family:'Geist',sans-serif;font-size:12px;font-weight:600;color:var(--brand);">${r.text}</span><span style="font-family:'Archivo Narrow',sans-serif;font-weight:700;font-size:12px;color:#1fcc4b;">x1.1</span>`;
            reasonsEl.appendChild(div);
            if (navigator.vibrate) navigator.vibrate(15);
          }, delay + i * 500);
        });

        setTimeout(() => {
          let current = score;
          const step = Math.max(1, Math.floor((finalScore - score) / 30));
          document.getElementById('multipliedScore').style.animation = 'fadeInUp 0.4s ease-out';
          const interval = setInterval(() => {
            current += step;
            if (current >= finalScore) {
              current = finalScore;
              clearInterval(interval);
              if (navigator.vibrate) navigator.vibrate([30, 50, 30]);
            }
            document.getElementById('multipliedScore').textContent = current.toLocaleString() + ' pts';
          }, 30);
        }, delay + reasons.length * 500 + 300);
      }

      // Submit multiplied score
      if (_username && score > 0) {
        SupabaseUtils.submitScore(_username, 'block_blast', finalScore).catch(() => {});
      }
    }

    // ========== EVENTS ==========
    document.getElementById('startBtn').addEventListener('click', () => {
      document.getElementById('welcomeScreen').classList.add('hidden');
      init();
    });

    document.getElementById('newGameBtn').addEventListener('click', init);
    document.getElementById('playAgainBtn').addEventListener('click', init);

    document.getElementById('shareBtn').addEventListener('click', () => {
      const text = `Hice ${score.toLocaleString()} puntos en Block Blast de El Dorado! Puedes superarme? \u{1F3C6}\u{1FA99}`;
      navigator.clipboard?.writeText(text).then(() => {
        const btn = document.getElementById('shareBtn');
        const orig = btn.textContent;
        btn.textContent = '\u{2705} COPIADO!';
        setTimeout(() => { btn.textContent = orig; }, 2000);
      }).catch(() => {});
    });

    // Recalculate on resize/orientation
    window.addEventListener('resize', () => setTimeout(cacheGridRect, 100));
    window.addEventListener('orientationchange', () => setTimeout(cacheGridRect, 300));

    // Prevent scroll/bounce on iOS
    document.addEventListener('touchmove', (e) => { if (draggingPiece) e.preventDefault(); }, { passive: false });

    // Init scores display
    document.getElementById('bestScore').textContent = bestScore.toLocaleString();
  </script>
</body>
</html>
